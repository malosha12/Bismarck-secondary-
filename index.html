<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bismarck Secondary School</title>
    <!-- Font Awesome for modern icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://unpkg.com/docxtemplater@3.37.12/build/docxtemplater.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --accent: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --highlight: #e91e63;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap');

.header {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    height: 220px;
    margin: 30px 10px;
    border-radius: 20px;
    overflow: hidden;
    background: url('https://images.unsplash.com/photo-1616627989397-fd57fb0bae7c?auto=format&fit=crop&w=1400&q=80') center/cover no-repeat;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
}

.header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(8px);
    z-index: 1;
}

.header h1,
.header p {
    position: relative;
    z-index: 2;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(90deg, var(--primary), var(--accent), var(--highlight));
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: textGradient 8s ease infinite;
}

.header h1 {
    font-size: 2.8rem;
    font-weight: 700;
    margin: 0;
}

.header p {
    font-size: 1.3rem;
    font-weight: 500;
    margin-top: 10px;
}

@keyframes textGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Rangi za kisasa */
:root {
    --primary: #00c6ff;
    --accent: #0072ff;
    --highlight: #ff6ec4;
    --light: #ecf0f1;
}
        .announcement-section {
            background: linear-gradient(135deg, var(--accent), var(--secondary));
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            color: white;
            animation: slideInAnnouncement 1s ease-out;
            border: 2px solid transparent;
            animation: glowBorder 3s infinite;
        }

        @keyframes slideInAnnouncement {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes glowBorder {
            0% { border-color: rgba(255, 255, 255, 0.3); }
            50% { border-color: rgba(255, 255, 255, 0.8); }
            100% { border-color: rgba(255, 255, 255, 0.3); }
        }

        .announcement-section .announcement-content {
            display: flex;
            align-items: center;
        }

        .announcement-section .timestamp {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .announcement-section .icon-bell {
            font-size: 1.8em;
            margin-right: 15px;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            list-style: none;
            margin-bottom: 20px;
            background-color: var(--light);
            padding: 10px;
            border-radius: 5px;
            box-shadow: var(--shadow);
        }

        .tab-item {
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
            border-bottom: 1px solid #ddd;
        }

        .tab-item:last-child {
            border-bottom: none;
        }

        .tab-item.active {
            background-color: var(--primary);
            color: white;
        }

        .tab-item:hover {
            background-color: #e0e0e0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .icon-home::before { content: 'üè†'; }
        .icon-user::before { content: 'üë§'; }
        .icon-list::before { content: 'üìã'; }
        .icon-results::before { content: 'üìù'; }
        .icon-view-results::before { content: 'üìä'; }
        .icon-past-results::before { content: 'üìö'; }
        .icon-academic::before { content: 'üîê'; }
        .icon-sms::before { content: 'üåê'; }
        .icon-reports::before { content: 'üìú'; }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 8px;
        }

        h3 {
            color: var(--dark);
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: var(--shadow);
        }

        .table th, .table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 11px;
            min-width: 50px;
        }

        .table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .table tr:hover {
            background-color: #f1f1f1;
        }

        .table-container {
            overflow-x: auto;
            max-width: 100%;
            margin-bottom: 15px;
        }

        .notification {
            position: fixed;
            top: 10px;
            right: -300px;
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 2000;
            max-width: 300px;
            font-size: 1rem;
            font-weight: 600;
            animation: slideIn 0.5s ease forwards, slideOut 0.5s ease 4s forwards;
        }

        .notification.success {
            background-color: var(--secondary);
        }

        .notification.error {
            background-color: var(--danger);
        }

        @keyframes slideIn {
            from { right: -300px; }
            to { right: 10px; }
        }

        @keyframes slideOut {
            from { right: 10px; }
            to { right: -300px; }
        }

        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress {
            height: 18px;
            background-color: var(--secondary);
            text-align: center;
            color: white;
            line-height: 18px;
            transition: width 0.3s ease;
        }

        .highlight-name {
            color: var(--highlight);
            font-weight: bold;
        }

        .powered-by {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .powered-by button {
            background-color: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            animation: textColorCycle 6s infinite;
        }

        @keyframes textColorCycle {
            0% { color: var(--primary); }
            33% { color: var(--secondary); }
            66% { color: var(--accent); }
            100% { color: var(--primary); }
        }

        .loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            text-align: center;
            overflow: hidden;
        }

        .loading-spinner.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .spinner-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 10%, transparent 11%);
            background-size: 20px 20px;
            animation: particleDrift 20s linear infinite;
        }

        @keyframes particleDrift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100px, -100px); }
        }

        .spinner {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 5px dashed var(--accent);
            border-radius: 50%;
            animation: spin 2s ease-in-out infinite;
        }

        .spinner-ring:nth-child(2) {
            border-color: var(--secondary);
            animation-duration: 2.5s;
            transform: scale(0.8);
        }

        .spinner-ring:nth-child(3) {
            border-color: var(--primary);
            animation-duration: 3s;
            transform: scale(0.6);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            animation: pulse 2s ease infinite;
        }

        .loading-spinner p {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .loading-spinner .motto {
            font-style: italic;
            color: var(--accent);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .print-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .print-header h1 {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .print-header p {
            font-size: 0.9em;
            color: #34495e;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        .summary-table th {
            background-color: var(--primary);
            color: white;
        }

        .phone-input {
            width: 150px;
            padding: 8px;
            font-size: 14px;
        }

        .sms-sent::after {
            content: '‚úî';
            color: var(--secondary);
            margin-left: 10px;
            font-size: 1.2em;
        }

        .report-container {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .report-table th, .report-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }

        .report-table th {
            background-color: var(--primary);
            color: white;
        }

        .report-footer {
            margin-top: 15px;
            font-size: 12px;
        }

        .report-footer p {
            margin-bottom: 8px;
        }

        @media print {
            .header, .tabs, .btn, .form-group, .powered-by, .announcement-section {
                display: none;
            }
            .tab-content.active {
                display: block !important;
            }
            .table-container, .summary-table, .report-container {
                page-break-inside: avoid;
            }
            .print-header {
                display: block;
            }
            .report-container {
                margin: 0;
                padding: 0;
            }
            .report-table, .report-footer {
                width: 100%;
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            .header {
                height: 100px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .header p {
                font-size: 1rem;
            }
            .tabs {
                padding: 5px;
            }
            .tab-item {
                font-size: 14px;
            }
            .card {
                padding: 15px;
            }
            .table th, .table td {
                font-size: 10px;
                padding: 6px;
            }
            .phone-input {
                width: 120px;
            }
            .report-table th, .report-table td {
                font-size: 10px;
            }
        }
        #smsStatus {
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}
#smsStatus p {
    margin: 5px 0;
}
#smsStatus strong {
    color: #333;
}
#reportStatus {
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}
#reportStatus p {
    margin: 5px 0;
}
#reportStatus strong {
    color: #333;
}
.progress-bar {
    width: 100%;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
}
.progress {
    height: 20px;
    background-color: #28a745;
    width: 0%;
    text-align: center;
    color: white;
    line-height: 20px;
    transition: width 0.3s;
}
.report-container {
    page-break-after: always;
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
}
.report-table {
    width: 100%;
    table-layout: fixed;
}
.report-table th, .report-table td {
    word-wrap: break-word;
    overflow-wrap: break-word;

.report-container {
    page-break-after: always; /* Each report starts on a new page */
    margin: 10px 0;
    font-size: 12px; /* Smaller font for compact layout */
    line-height: 1.2; /* Reduced line spacing */
}

@media print {
    .report-container {
        width: 100%;
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
        page-break-after: always;
    }
    .print-header h1 {
        font-size: 16px;
        margin: 5px 0;
    }
    .print-header h2 {
        font-size: 14px;
        margin: 5px 0;
    }
    .print-header p {
        font-size: 12px;
        margin: 3px 0;
    }
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
    }
    .report-table th, .report-table td {
        border: 1px solid #000;
        padding: 3px;
        text-align: left;
    }
    .report-footer p {
        font-size: 10px;
        margin: 3px 0;
    }
    .report-footer textarea {
        width: 100%;
        height: 40px; /* Reduced height for comments */
        font-size: 10px;
    }
    .save-report-btn, .print-report-btn, .global-comments {
        display: none; /* Hide buttons and global comments in print */
    }
    h3 {
        font-size: 12px;
        margin: 5px 0;
    }
}
.report-container {
    page-break-after: always;
    margin: 10px 0;
    font-size: 12px;
    line-height: 1.2;
    display: block;
    visibility: visible;
}
@media print {
    .report-container {
        width: 100%;
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
        page-break-after: always;
        display: block !important;
        visibility: visible !important;
    }
    .print-header h1 { font-size: 16px; margin: 5px 0; }
    .print-header h2 { font-size: 14px; margin: 5px 0; }
    .print-header p { font-size: 12px; margin: 3px 0; }
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
    }
    .report-table th, .report-table td {
        border: 1px solid #000;
        padding: 3px;
        text-align: left;
    }
    .report-footer p { font-size: 10px; margin: 3px 0; }
    .save-report-btn, .print-report-btn, .export-word-btn, .global-comments { display: none !important; }
    h3 { font-size: 12px; margin: 5px 0; }
}
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-background"></div>
        <div class="spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
        <h1>Bismarck Secondary School</h1>
        <p>Welcome to Our Student Management System</p>
        <p class="motto">Education for Excellence</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>BISMARCK SECONDARY SCHOOL</h1>
            <p>Student Management System</p>
        </div>

        <div class="announcement-section" id="announcementSection">
            <div class="announcement-content">
                <i class="fa-solid fa-bell icon-bell"></i>
                <div>
                    <div class="timestamp" id="announcementTimestamp"></div>
                    <p id="announcementText">No announcements at the moment.</p>
                </div>
            </div>
        </div>

        <div class="tab-container">
            <ul class="tabs">
                <li class="tab-item active" data-tab="home"><span class="icon icon-home"></span>HOME</li>
                <li class="tab-item" data-tab="register"><span class="icon icon-user"></span>REGISTER STUDENTS</li>
                <li class="tab-item" data-tab="students"><span class="icon icon-list"></span>VIEW STUDENT LIST</li>
                <li class="tab-item" data-tab="resultsEntry"><span class="icon icon-results"></span>ENTER RESULTS</li>
                <li class="tab-item" data-tab="results"><span class="icon icon-view-results"></span>VIEW CURRENT RESULTS </li>
                <li class="tab-item" data-tab="pastResults"><span class="icon icon-past-results"></span> VIEW PAST RESULTS</li>
                <li class="tab-item" data-tab="sms"><span class="icon icon-sms"></span>SEND EXAM RESULTS TO PARENTS.</li>
                <li class="tab-item" data-tab="academic"><span class="icon icon-academic"></span>RESTRICTED T0 HEADMASTER AND ACADEMIC</li>
                <li class="tab-item" data-tab="studentReports"><span class="icon icon-reports"></span>VIEW GENERATED REPORTS </li>
            </ul>

            <!-- Home Tab -->
            <div id="home" class="tab-content active">
                <div class="card">
                    <h2>Welcome to Bismarck Secondary School</h2>
                                        <p>This system manages student registration, results entry, and academic administration efficiently.</p>
                    <h3>Features:</h3>
                    <ul>
                        <li>Bulk student registration</li>
  <li>Organized student lists</li>
                        <li>Secure result entry with teacher authentication</li>
                        <li>Comprehensive result viewing and printing</li>
                        <li>Past results archiving</li>
                        <li>SMS notifications to parents</li>
                        <li>Individual student reports</li>
                    </ul>
                </div>
            </div>

            <!-- Register Students Tab -->
              <div id="register" class="tab-content">
                <div class="card">
                    <h2>Register Students</h2>
                                         <button class="btn btn-danger" onclick="goBack()">Back</button>
                    <form id="registrationForm">
                        <div class="form-group">
                            <label for="studentNames">Student Names (one per line)</label>
                            <textarea id="studentNames" name="studentNames" rows="6" placeholder="Name 1\nName 2\nName 3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="class">Class</label>
                            <select id="class" name="class" required>
                                <option value="">Select Class</option>
                                <option value="Form 1">Form 1</option>
                                <option value="Form 2">Form 2</option>
                                <option value="Form 3">Form 3</option>
                                <option value="Form 4">Form 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="stream">Stream</label>
                            <select id="stream" name="stream" required>
                                <option value="">Select Stream</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="year">Year</label>
                            <select id="year" name="year" required>
                                <option value="">Select Year</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="regDate">Registration Date</label>
                            <input type="date" id="regDate" name="regDate" required>
                        </div>
                        <div class="form-group">
                            <label for="takesBusinessStudy">Takes Business Study?</label>
                            <input type="checkbox" id="takesBusinessStudy" name="takesBusinessStudy">
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>

            <!-- Students List Tab -->
            <div id="students" class="tab-content">
                <div class="card">
                    <h2>Students List</h2>
                    <button class="btn btn-danger" onclick="goBack()">Back</button>
                    <div class="form-group">
                        <label for="searchStudentName">Search Student by Name</label>
                        <input type="text" id="searchStudentName" placeholder="Enter student name">
                        <button class="btn btn-primary" id="searchStudentBtn">Search</button>
                    </div>
                    <div class="form-group">
                        <label for="searchExamType">Exam Type</label>
                        <select id="searchExamType">
                            <option value="">Select Exam Type</option>
                            <option value="Midterm">Midterm</option>
                            <option value="Terminal">Terminal</option>
                            <option value="Weekly Test">Weekly Test</option>
                            <option value="Mock">Mock</option>
                            <option value="Pre-National">Pre-National</option>
                            <option value="Annual">Annual</option>
                            <option value="Classes Test">Classes Test</option>
                            <option value="Other Exam">Other Exam</option>
                        </select>
                    </div>
                    <div id="searchResults"></div>
                    <div class="form-group">
                        <label for="studentClass">Class</label>
                        <select id="studentClass">
                            <option value="">Select Class</option>
                            <option value="Form 1">Form 1</option>
                            <option value="Form 2">Form 2</option>
                            <option value="Form 3">Form 3</option>
                            <option value="Form 4">Form 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentStream">Stream</label>
                        <select id="studentStream">
                            <option value="">Select Stream</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentYear">Year</label>
                        <select id="studentYear">
                            <option value="">Select Year</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="viewStudentsBtn">View List</button>
                    <button class="btn btn-success" id="showStudentListBtn">Show Student List</button>
                    <button class="btn btn-danger" id="hideStudentListBtn" style="display: none;">Hide Student List</button>
                    <div id="studentList" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>

            <!-- Enter Results Tab -->
           <div id="resultsEntry" class="tab-content">
                <div class="card" id="teacherAuthPanel">
                    <h2>TEACHER AUTHENTICATION</h2>
                    <form id="teacherAuthForm">
                        <div class="form-group">
                            <label for="authTeacherName">Teacher Name</label>
                            <input type="text" id="authTeacherName" required>
                        </div>
                        <div class="form-group">
                            <label for="authTeacherPassword">Password</label>
                            <input type="password" id="authTeacherPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="authSubject">Subject</label>
                            <select id="authSubject" required>
                                <option value="">Select Subject</option>
                                <option value="Tanzania History">Tanzania History</option>
                                <option value="History">History</option>
                                <option value="Geography">Geography</option>
                                <option value="Kiswahili">Kiswahili</option>
                                <option value="English">English</option>
                                <option value="Biology">Biology</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Physics">Physics</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Business Study">Business Study</option>
                                <option value="EDK">EDK</option>
                                <option value="Book Keeping">Book Keeping</option>
                                <option value="Civics">Civics</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" id="registerTeacherBtn">Register</button>
                        <button type="submit" class="btn btn-success" id="loginTeacherBtn">Login</button>
                    </form>
                </div>

                <div id="resultsEntryPanel" class="card" style="display: none;">
                    <h2>Enter Results</h2>
                    <button class="btn btn-danger" id="logoutTeacherBtn">Logout</button>
                    <button class="btn btn-danger" onclick="goBack()">Back</button>
                    <div class="form-group">
                        <label for="resultClass">Class</label>
                        <select id="resultClass" required>
                            <option value="">Select Class</option>
                            <option value="Form 1">Form 1</option>
                            <option value="Form 2">Form 2</option>
                            <option value="Form 3">Form 3</option>
                            <option value="Form 4">Form 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resultStream">Stream</label>
                        <select id="resultStream" required>
                            <option value="">Select Stream</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resultYear">Year</label>
                        <select id="resultYear" required>
                            <option value="">Select Year</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resultExamType">Exam Type</label>
                        <select id="resultExamType" required>
                            <option value="">Select Exam Type</option>
                            <option value="Midterm">Midterm</option>
                            <option value="Terminal">Terminal</option>
                            <option value="Weekly Test">Weekly Test</option>
                            <option value="Mock">Mock</option>
                            <option value="Pre-National">Pre-National</option>
                            <option value="Annual">Annual</option>
                            <option value="Classes Test">Classes Test</option>
                            <option value="Other Exam">Other Exam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resultSubject">Subject</label>
                        <select id="resultSubject" required disabled>
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="loadStudentsForResultsBtn">Start Entering Results</button>
                    <button class="btn btn-success" id="showResultEntryFormBtn">Show Results Entry Form</button>
                    <button class="btn btn-danger" id="hideResultEntryFormBtn" style="display: none;">Hide Results Entry Form</button>
                    <div id="resultEntryForm" style="margin-top: 15px; display: none;">
                        <h3>Enter Marks for <span id="currentStudent" class="highlight-name"></span></h3>
                        <div class="progress-bar">
                            <div class="progress" id="progressBar"></div>
                        </div>
                        <p id="progressText"></p>
                        <div class="form-group">
                            <label for="marks">Marks (0‚Äì100)</label>
                            <input type="number" id="marks" min="0" max="100" required>
                        </div>
                        <button class="btn btn-success" id="saveMarksBtn">Save Marks</button>
                    </div>
                    <button class="btn btn-success" id="showResultsTableBtn">Show Results Table</button>
                    <button class="btn btn-danger" id="hideResultsTableBtn" style="display: none;">Hide Results Table</button>
                    <div id="resultsTable" style="margin-top: 15px; display: none;"></div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" id="submitResultsBtn">Submit Results</button>
                    </div>
                </div>

                <div id="editResultsPanel" class="card" style="display: none;">
                    <h2>Edit Results</h2>
                    <button class="btn btn-danger" onclick="goBack()">Back</button>
                    <div class="form-group">
                        <label for="editResultClass">Class</label>
                        <select id="editResultClass">
                            <option value="">Select Class</option>
                            <option value="Form 1">Form 1</option>
                            <option value="Form 2">Form 2</option>
                            <option value="Form 3">Form 3</option>
                            <option value="Form 4">Form 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editResultStream">Stream</label>
                        <select id="editResultStream">
                            <option value="">Select Stream</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editResultYear">Year</label>
                        <select id="editResultYear">
                            <option value="">Select Year</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editResultExamType">Exam Type</label>
                        <select id="editResultExamType">
                            <option value="">Select Exam Type</option>
                            <option value="Midterm">Midterm</option>
                            <option value="Terminal">Terminal</option>
                            <option value="Weekly Test">Weekly Test</option>
                            <option value="Mock">Mock</option>
                            <option value="Pre-National">Pre-National</option>
                            <option value="Annual">Annual</option>
                            <option value="Classes Test">Classes Test</option>
                            <option value="Other Exam">Other Exam</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editResultSubject">Subject</label>
                        <select id="editResultSubject">
                            <option value="">Select Subject</option>
                            <option value="Tanzania History">Tanzania History</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="Kiswahili">Kiswahili</option>
                            <option value="English">English</option>
                            <option value="Biology">Biology</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Physics">Physics</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Business Study">Business Study</option>
                            <option value="EDK">EDK</option>
                            <option value="Book Keeping">Book Keeping</option>
                            <option value="Civics">Civics</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="loadEditResultsBtn">Load Results to Edit</button>
                    <button class="btn btn-success" id="showEditResultsTableBtn">Show Edit Results Table</button>
                    <button class="btn btn-danger" id="hideEditResultsTableBtn" style="display: none;">Hide Edit Results Table</button>
                    <div id="editResultsTable" style="margin-top: 15px; display: none;"></div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" id="updateResultsBtn">Update Results</button>
                    </div>
                </div>
            </div>
            
            <!-- View Results Tab -->
             <div id="results" class="tab-content">
    <div class="card">
        <h2>View Results</h2>
        <button class="btn btn-danger" onclick="goBack()">Back</button>
        <div class="form-group">
            <label for="searchResultsName">Search Student by Name</label>
            <input type="text" id="searchResultsName" placeholder="Enter student name">
        </div>
        <div class="form-group">
            <label for="resultsClass">Class</label>
            <select id="resultsClass">
                <option value="">Select Class</option>
                <option value="Form 1">Form 1</option>
                <option value="Form 2">Form 2</option>
                <option value="Form 3">Form 3</option>
                <option value="Form 4">Form 4</option>
            </select>
        </div>
        <div class="form-group">
            <label for="resultsStream">Stream</label>
            <select id="resultsStream">
                <option value="">Select Stream</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
        </div>
        <div class="form-group">
            <label for="resultsYear">Year</label>
            <select id="resultsYear">
                <option value="">Select Year</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
        </div>
        <div class="form-group">
            <label for="resultsExamType">Exam Type</label>
            <select id="resultsExamType">
                <option value="">Select Exam Type</option>
                <option value="Midterm">Midterm</option>
                <option value="Terminal">Terminal</option>
                <option value="Weekly Test">Weekly Test</option>
                <option value="Mock">Mock</option>
                <option value="Pre-National">Pre-National</option>
                <option value="Annual">Annual</option>
                <option value="Classes Test">Classes Test</option>
                <option value="Other Exam">Other Exam</option>
            </select>
        </div>
        <button class="btn btn-primary" id="viewResultsBtn">View Results</button>
        <button class="btn btn-success" id="printResultsBtn">Print Results (PDF)</button>
        <button class="btn btn-success" id="exportToCSVBtn">Export to CSV</button>
        <button class="btn btn-success" id="exportToWordBtn">Export to Word</button>
        <button class="btn btn-success" id="exportToExcelBtn">Export to Excel</button>
        <button class="btn btn-success" id="showResultsDisplayBtn">Show Results</button>
        <button class="btn btn-danger" id="hideResultsDisplayBtn" style="display: none;">Hide Results</button>
        <div id="resultsDisplay" style="margin-top: 15px; display: none;"></div>
    </div>
</div>
            <!-- Past Results Tab -->
            <div id="pastResults" class="tab-content">
    <div class="card">
        <h2>Past Results</h2>
        <button class="btn btn-danger" onclick="goBack()">Back</button>
        <div class="form-group">
            <label for="searchPastResultsName">Search Student by Name</label>
            <input type="text" id="searchPastResultsName" placeholder="Enter student name">
        </div>
        <div class="form-group">
            <label for="pastResultsClass">Class</label>
            <select id="pastResultsClass">
                <option value="">Select Class</option>
                <option value="Form 1">Form 1</option>
                <option value="Form 2">Form 2</option>
                <option value="Form 3">Form 3</option>
                <option value="Form 4">Form 4</option>
            </select>
        </div>
        <div class="form-group">
            <label for="pastResultsStream">Stream</label>
            <select id="pastResultsStream">
                <option value="">Select Stream</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
        </div>
        <div class="form-group">
            <label for="pastResultsYear">Year</label>
            <select id="pastResultsYear">
                <option value="">Select Year</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
        </div>
        <div class="form-group">
            <label for="pastResultsExamType">Exam Type</label>
            <select id="pastResultsExamType">
                <option value="">Select Exam Type</option>
                <option value="Midterm">Midterm</option>
                <option value="Terminal">Terminal</option>
                <option value="Weekly Test">Weekly Test</option>
                <option value="Mock">Mock</option>
                <option value="Pre-National">Pre-National</option>
                <option value="Annual">Annual</option>
                <option value="Classes Test">Classes Test</option>
                <option value="Other Exam">Other Exam</option>
            </select>
        </div>
        <button class="btn btn-primary" id="viewPastResultsBtn">View Past Results</button>
        <button class="btn btn-success" id="showPastResultsDisplayBtn">Show Past Results</button>
        <button class="btn btn-success" id="printPastResultsBtn">Print Past Results (PDF)</button>
        <button class="btn btn-success" id="exportPastToWordBtn">Export to Word</button>
        <button class="btn btn-success" id="exportPastToExcelBtn">Export to Excel</button>
        <button class="btn btn-danger" id="hidePastResultsDisplayBtn" style="display: none;">Hide Past Results</button>
        <div id="pastResultsDisplay" style="margin-top: 15px; display: none;"></div>
    </div>
</div>
            <!-- Send SMS Tab -->
          <div id="sms" class="tab-content">
    <div class="card">
        <h2>Send SMS to Parents</h2>
        <button class="btn btn-danger" onclick="goBack()">Back</button>
        <div class="form-group">
            <label for="smsClass">Class</label>
            <select id="smsClass">
                <option value="">Select Class</option>
                <option value="Form 1">Form 1</option>
                <option value="Form 2">Form 2</option>
                <option value="Form 3">Form 3</option>
                <option value="Form 4">Form 4</option>
            </select>
        </div>
        <div class="form-group">
            <label for="smsStream">Stream</label>
            <select id="smsStream">
                <option value="">Select Stream</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
        </div>
        <div class="form-group">
            <label for="smsYear">Year</label>
            <select id="smsYear">
                <option value="">Select Year</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
        </div>
        <div class="form-group">
            <label for="smsExamType">Exam Type</label>
            <select id="smsExamType">
                <option value="">Select Exam Type</option>
                <option value="Midterm">Midterm</option>
                <option value="Terminal">Terminal</option>
                <option value="Weekly Test">Weekly Test</option>
                <option value="Mock">Mock</option>
                <option value="Pre-National">Pre-National</option>
                <option value="Annual">Annual</option>
                <option value="Classes Test">Classes Test</option>
                <option value="Other Exam">Other Exam</option>
            </select>
        </div>
        <button class="btn btn-primary" id="loadStudentsForSMSBtn">Load Students</button>
        <div id="smsStatus" style="margin-top: 15px;">
            <p><strong>Sent SMS:</strong> <span id="sentCount">0</span></p>
            <p><strong>Pending SMS:</strong> <span id="pendingCount">0</span></p>
        </div>
        <div class="form-group">
            <label><input type="checkbox" id="markAllSMS"> Mark All</label>
        </div>
        <div id="smsStudentList" style="margin-top: 15px;"></div>
    </div>
</div>
            <!-- Academic Office Tab -->
            <div id="academic" class="tab-content">
                <div class="card">
                    <h2>"If you're not the headmaster or academic staff, please leave this page-it's not for you"</h2>
                    <button class="btn btn-danger" onclick="goBack()">Back</button>
                    <div id="academicLoginForm">
                        <div class="form-group">
                            <label for="academicPassword">Password</label>
                            <input type="password" id="academicPassword">
                        </div>
                        <button class="btn btn-primary" id="loginAcademicBtn">Login</button>
                    </div>
                    <div id="academicPanel" style="display: none;">
                        <h2>Academic Office</h2>
                        <button class="btn btn-danger" id="logoutAcademicBtn">Logout</button>
                        <div class="card">
                            <h3>Configure Exam Types</h3>
                            <form id="examTypeSettingsForm">
                                <div class="form-group">
                                    <label for="allowedExamTypes">Allowed Exam Types</label>
                                    <select id="allowedExamTypes" multiple required>
                                        <option value="Midterm">Midterm</option>
                                        <option value="Terminal">Terminal</option>
                                        <option value="Weekly Test">Weekly Test</option>
                                        <option value="Mock">Mock</option>
                                        <option value="Pre-National">Pre-National</option>
                                        <option value="Annual">Annual</option>
                                        <option value="Classes Test">Classes Test</option>
                                        <option value="Other Exam">Other Exam</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </form>
                        </div>
                        <div class="card">
                            <h3>Manage Announcement</h3>
                            <form id="announcementForm">
                                <div class="form-group">
                                    <label for="announcementText">Announcement</label>
                                    <textarea id="announcementTextInput" rows="4" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Post/Update</button>
                                <button type="button" class="btn btn-danger" id="deleteAnnouncementBtn">Delete</button>
                            </form>
                        </div>
                        <div class="card">
                            <h3>Registered Teachers</h3>
                            <div id="teacherList"></div>
                            <button class="btn btn-danger" id="deleteTeacherBtn">Delete Selected</button>
                        </div>
                        <div class="card">
                            <h3>Registered Students</h3>
                            <div class="form-group">
                                <label for="deleteStudentClass">Class</label>
                                <select id="deleteStudentClass">
                                    <option value="">Select Class</option>
                                    <option value="Form 1">Form 1</option>
                                    <option value="Form 2">Form 2</option>
                                    <option value="Form 3">Form 3</option>
                                    <option value="Form 4">Form 4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deleteStudentStream">Stream</label>
                                <select id="deleteStudentStream">
                                    <option value="">Select Stream</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deleteStudentYear">Year</label>
                                <select id="deleteStudentYear">
                                    <option value="">Select Year</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div id="studentDeleteList"></div>
                            <button class="btn btn-danger" id="deleteStudentBtn">Delete Selected</button>
                        </div>
                        <div class="card">
                            <h3>Feature Visibility</h3>
                            <form id="featureVisibilityForm">
                                <div class="form-group">
                                    <label>Visible Tabs</label>
                                    <label><input type="checkbox" id="visibleRegister" checked> Register Students</label>
                                    <label><input type="checkbox" id="visibleStudents" checked> Students List</label>
                                    <label><input type="checkbox" id="visibleResultsEntry" checked> Enter Results</label>
                                    <label><input type="checkbox" id="visibleResults" checked> View Results</label>
                                    <label><input type="checkbox" id="visiblePastResults" checked> Past Results</label>
                                    <label><input type="checkbox" id="visibleSMS" checked> Send SMS</label>
                                    <label><input type="checkbox" id="visibleStudentReports" checked> Student Reports</label>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Visibility</button>
                            </form>
                        </div>
                        <div class="card">
                            <h3>Change Password</h3>
                            <div class="card">
    <h3>Global Report Settings</h3>
    <form id="globalReportSettingsForm">
        <div class="form-group">
            <label for="globalClassTeacherComment">Class Teacher Comment (Optional)</label>
            <textarea id="globalClassTeacherComment" rows="4" placeholder="Enter class teacher comment for all students"></textarea>
        </div>
        <div class="form-group">
            <label for="globalHeadTeacherComment">Head Teacher Comment (Optional)</label>
            <textarea id="globalHeadTeacherComment" rows="4" placeholder="Enter head teacher comment for all students"></textarea>
        </div>
        <h4>Behavior and Conduct (Optional)</h4>
        ${['Usafi', 'Uaminifu', 'Michezo', 'Nidhamu', 'Kazi', 'Utunzaji Mali', 'Uongozi'].map(criteria => `
            <div class="form-group">
                <label for="globalConduct_${criteria.toLowerCase()}">${criteria}</label>
                <select id="globalConduct_${criteria.toLowerCase()}">
                    <option value="">Not Set</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="F">F</option>
                </select>
            </div>
        `).join('')}
        <button type="submit" class="btn btn-primary">Save Global Settings</button>
    </form>
</div>
                            <form id="changePasswordForm">
                                <div class="form-group">
                                    <label for="newAcademicPassword">New Password</label>
                                    <input type="password" id="newAcademicPassword" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmAcademicPassword">Confirm Password</label>
                                    <input type="password" id="confirmAcademicPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Change Password</button>
                            </form>
                        </div>
                        <div class="card">
                            <h3>Delete Results</h3>
                                                                <div class="form-group">
                                <label for="deleteClass">Class</label>
                                <select id="deleteClass">
                                    <option value="">Select Class</option>
                                    <option value="Form 1">Form 1</option>
                                    <option value="Form 2">Form 2</option>
                                    <option value="Form 3">Form 3</option>
                                    <option value="Form 4">Form 4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deleteStream">Stream</label>
                                <select id="deleteStream">
                                    <option value="">Select Stream</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deleteYear">Year</label>
                                <select id="deleteYear">
                                    <option value="">Select Year</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deleteExamType">Exam Type</label>
                                <select id="deleteExamType">
                                    <option value="">Select Exam Type</option>
                                    <option value="Midterm">Midterm</option>
                                    <option value="Terminal">Terminal</option>
                                    <option value="Weekly Test">Weekly Test</option>
                                    <option value="Mock">Mock</option>
                                    <option value="Pre-National">Pre-National</option>
                                    <option value="Annual">Annual</option>
                                    <option value="Classes Test">Classes Test</option>
                                    <option value="Other Exam">Other Exam</option>
                                </select>
                            </div>
                            <button class="btn btn-danger" id="deleteResultsBtn">Delete Results</button>
                        </div>
                        <div class="card">
                            <h3>Archive Results</h3>
                            <div class="form-group">
                                <label for="archiveClass">Class</label>
                                <select id="archiveClass">
                                    <option value="">Select Class</option>
                                    <option value="Form 1">Form 1</option>
                                    <option value="Form 2">Form 2</option>
                                    <option value="Form 3">Form 3</option>
                                    <option value="Form 4">Form 4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="archiveStream">Stream</label>
                                <select id="archiveStream">
                                    <option value="">Select Stream</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="archiveYear">Year</label>
                                <select id="archiveYear">
                                    <option value="">Select Year</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="archiveExamType">Exam Type</label>
                                <select id="archiveExamType">
                                    <option value="">Select Exam Type</option>
                                    <option value="Midterm">Midterm</option>
                                    <option value="Terminal">Terminal</option>
                                    <option value="Weekly Test">Weekly Test</option>
                                    <option value="Mock">Mock</option>
                                    <option value="Pre-National">Pre-National</option>
                                    <option value="Annual">Annual</option>
                                    <option value="Classes Test">Classes Test</option>
                                    <option value="Other Exam">Other Exam</option>
                                </select>
                            </div>
                            <button class="btn btn-success" id="archiveResultsBtn">Archive</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Reports Tab -->
           <div id="studentReports" class="tab-content">
    <div class="card">
        <h2>Student Reports</h2>
        <button class="btn btn-danger" onclick="goBack()">Back</button>
        <div class="form-group">
            <label for="reportClass">Class</label>
            <select id="reportClass">
                <option value="">Select Class</option>
                <option value="Form 1">Form 1</option>
                <option value="Form 2">Form 2</option>
                <option value="Form 3">Form 3</option>
                <option value="Form 4">Form 4</option>
            </select>
        </div>
        <div class="form-group">
            <label for="reportStream">Stream</label>
            <select id="reportStream">
                <option value="">Select Stream</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
        </div>
        <div class="form-group">
            <label for="reportYear">Year</label>
            <select id="reportYear">
                <option value="">Select Year</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
        </div>
        <div class="form-group">
            <label for="reportExamType">Exam Type</label>
            <select id="reportExamType">
                <option value="">Select Exam Type</option>
                <option value="Midterm">Midterm</option>
                <option value="Terminal">Terminal</option>
                <option value="Weekly Test">Weekly Test</option>
                <option value="Mock">Mock</option>
                <option value="Pre-National">Pre-National</option>
                <option value="Annual">Annual</option>
                <option value="Classes Test">Classes Test</option>
                <option value="Other Exam">Other Exam</option>
            </select>
        </div>
        <div class="form-group">
            <label for="schoolCloseDate">School Closure Date</label>
            <input type="date" id="schoolCloseDate">
        </div>
        <div class="form-group">
            <label for="schoolReopenDate">School Reopening Date</label>
            <input type="date" id="schoolReopenDate">
        </div>
        <button class="btn btn-primary" id="generateReportsBtn">Generate Reports</button>
        <button class="btn btn-success" id="printReportsBtn">Print Reports (PDF)</button>
        <button class="btn btn-success" id="autoPrintReportsBtn">Auto Print Individual Reports</button>
        <button class="btn btn-success" id="exportReportsToWordBtn">Export to Word</button>
        <button class="btn btn-success" id="exportReportsToExcelBtn">Export to Excel</button>
        <div id="reportStatus" style="margin-top: 15px;">
            <p><strong>Saved Reports:</strong> <span id="savedReportCount">0</span></p>
            <p><strong>Pending Reports:</strong> <span id="pendingReportCount">0</span></p>
            <div class="progress-bar">
                <div class="progress" id="reportProgressBar"></div>
            </div>
        </div>
        <div id="reportsDisplay" style="margin-top: 15px;"></div>
    </div>
</div>

        <div class="powered-by">
            <button id="poweredByBtn">POWERED BY BISMARCK SECONDARY</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://unpkg.com/docxtemplater@3.37.12/build/docxtemplater.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- html2docx (for Word export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.28.0/docxtemplater.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        /* jslint browser: true, devel: true, es6: true */
        "use strict";

        // Variables
        let ACADEMIC_PASSWORD = '1340';
        let students = [];
        let teachers = [];
        let results = [];
        let pastResults = [];
        let currentAnnouncement = null;
        let allowedExamTypes = ['Midterm', 'Terminal', 'Weekly Test', 'Mock', 'Pre-National', 'Annual', 'Classes Test', 'Other Exam'];
        let currentTeacher = null;
        let currentAcademic = null;
        let currentStudentsForResults = [];
        let currentStudentIndex = 0;
        let tempResults = [];
        let smsStudents = [];
        let sentSMSes = [];
        let visibleFeatures = {
            register: true,
            students: true,
            resultsEntry: true,
            results: true,
            pastResults: true,
            sms: true,
            studentReports: true
        };
        let navigationHistory = ['home'];

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCM7B6xJ1Xv8QVtE0ZEXBkJKvwHxSqCfaA",
            authDomain: "bismarck-secondary-30220.firebaseapp.com",
            databaseURL: "https://bismarck-secondary-30220-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bismarck-secondary-30220",
            storageBucket: "bismarck-secondary-30220.firebasestorage.app",
            messagingSenderId: "826271341853",
            appId: "1:826271341853:web:7b48672a4bcb7c9d0455f4",
            measurementId: "G-20KQLWBT8E"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const maleNames = ['John', 'Joseph', 'Emmanuel', 'David', 'Peter', 'James', 'Michael', 'Thomas', 'Paul', 'Steven', 'Abdul', 'Hassan'];
        const femaleNames = ['Mary', 'Anna', 'Elizabeth', 'Grace', 'Fatuma', 'Rose', 'Sarah', 'Esther', 'Lilian', 'Mercy', 'Zainab', 'Aisha'];

        // Utility Functions
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<strong>${title}</strong><p>${message}</p>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4500);
        }
        
        function loadDocxTemplate(templateContent) {
    return new Promise((resolve, reject) => {
        try {
            const zip = new JSZip(); // Create new JSZip instance without parameters
            zip.file('[Content_Types].xml', `
                <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
                    <Default Extension="xml" ContentType="application/xml"/>
                    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
                    <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
                </Types>
            `);
            zip.file('word/document.xml', templateContent);
            zip.file('word/styles.xml', `
                <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                <w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:style w:type="paragraph" w:styleId="Normal">
                        <w:name w:val="Normal"/>
                        <w:qFormat/>
                    </w:style>
                    <w:style w:type="table" w:styleId="TableGrid">
                        <w:name w:val="Table Grid"/>
                        <w:basedOn w:val="TableNormal"/>
                        <w:uiPriority w:val="59"/>
                        <w:rsId w:val="002B7A5A"/>
                        <w:pPr>
                            <w:spacing w:after="0" w:line="240" w:lineRule="auto"/>
                        </w:pPr>
                        <w:tblPr>
                            <w:tblBorders>
                                <w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                <w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                <w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                <w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                <w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                <w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                            </w:tblBorders>
                        </w:tblPr>
                    </w:style>
                </w:styles>
            `);
            zip.file('_rels/.rels', `
                <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
                    <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="word/styles.xml"/>
                </Relationships>
            `);
            zip.file('word/_rels/document.xml.rels', `
                <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
                </Relationships>
            `);
            zip.generateAsync({ type: 'blob' }).then(blob => resolve(blob));
        } catch (error) {
            reject(error);
        }
    });
}
        function getGrade(marks) {
            if (marks >= 75 && marks <= 100) return 'A';
            if (marks >= 65 && marks <= 74) return 'B';
            if (marks >= 45 && marks <= 64) return 'C';
            if (marks >= 30 && marks <= 44) return 'D';
            return 'F';
        }

        function getPoints(grade) {
            switch (grade) {
                case 'A': return 1;
                case 'B': return 2;
                case 'C': return 3;
                case 'D': return 4;
                case 'F': return 5;
                default: return null;
            }
        }

        function getDivision(pointsArray) {
    console.log('Points Array:', pointsArray);
    const validPoints = pointsArray.filter(p => p !== null);
    console.log('Valid Points:', validPoints);
    if (validPoints.length < 7) {
        console.log('Less than 7 valid subjects, returning FAIL');
        return 'FAIL';
    }

    const subjects = getSubjects();
    const edkIndex = subjects.indexOf('EDK');
    const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
    console.log('EDK Point:', edkPoint);

    const otherPoints = validPoints
        .filter((p, idx) => idx !== edkIndex || edkPoint === null)
        .sort((a, b) => a - b);
    console.log('Sorted Other Points:', otherPoints);

    let topPoints = [];
    if (edkPoint !== null) {
        topPoints = [edkPoint, ...otherPoints.slice(0, 6)];
    } else {
        topPoints = otherPoints.slice(0, 7);
    }
    console.log('Top Points:', topPoints);

    if (topPoints.length < 7) {
        console.log('Less than 7 top points, returning FAIL');
        return 'FAIL';
    }

    const totalPoints = topPoints.reduce((sum, p) => sum + p, 0);
    console.log('Total Points:', totalPoints);

    if (totalPoints >= 7 && totalPoints <= 17) return 'I';
    if (totalPoints >= 18 && totalPoints <= 21) return 'II';
    if (totalPoints >= 22 && totalPoints <= 25) return 'III';
    if (totalPoints >= 26 && totalPoints <= 33) return 'IV';
    console.log('Returning FAIL for total points:', totalPoints);
    return 'FAIL';
}

        function getOverallGrade(studentResults) {
    if (!studentResults || !Array.isArray(studentResults)) {
        return '-';
    }
    let totalMarks = 0;
    let validSubjects = 0;
    studentResults.forEach(result => {
        if (result && result.marks != null) { // Check for null/undefined result and marks
            totalMarks += parseInt(result.marks) || 0; // Use 0 if parseInt fails
            validSubjects++;
        }
    });
    if (validSubjects === 0) {
        return '-';
    }
    const averageMarks = totalMarks / validSubjects;
    return getGrade(averageMarks);
}
        function generateGradeSummary(students, results, examType, year) {
    const summary = {
        A: { male: 0, female: 0, total: 0 },
        B: { male: 0, female: 0, total: 0 },
        C: { male: 0, female: 0, total: 0 },
        D: { male: 0, female: 0, total: 0 },
        F: { male: 0, female: 0, total: 0 }
    };
console.log('getOverallGrade studentResults:', studentResults);
    students.forEach(student => {
        const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
        let totalMarks = 0;
        let validSubjects = 0;
        studentResults.forEach(result => {
            if (result.marks !== null && result.marks !== undefined) {
                totalMarks += parseInt(result.marks);
                validSubjects++;
            }
        });
        if (validSubjects > 0) {
            const averageMarks = totalMarks / validSubjects;
            const overallGrade = getGrade(averageMarks);
            const gender = student.gender.toLowerCase();
            summary[overallGrade][gender]++;
            summary[overallGrade].total++;
        }
    });

    let html = `
        <h3>Overall Grade Summary</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Grade</th>
                        <th>Male</th>
                        <th>Female</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${['A', 'B', 'C', 'D', 'F'].map(grade => `
                        <tr>
                            <td>${grade}</td>
                            <td>${summary[grade].male}</td>
                            <td>${summary[grade].female}</td>
                            <td>${summary[grade].total}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    return html;
}
        
        function getSubjects() {
            return [
                'EDK', 'Tanzania History', 'History', 'Geography', 'Kiswahili', 'English',
                'Biology', 'Chemistry', 'Physics', 'Mathematics', 'Business Study',
                'Book Keeping', 'Civics'
            ];
        }

        function getSubjectAbbreviation(subject) {
            const abbreviations = {
                'EDK': 'EDK',
                'Tanzania History': 'T-HIST',
                'History': 'HIST',
                'Geography': 'GEOG',
                'Kiswahili': 'KISW',
                'English': 'ENGL',
                'Biology': 'BIO',
                'Chemistry': 'CHEM',
                'Physics': 'PHYS',
                'Mathematics': 'MATH',
                'Business Study': 'B-STUDY',
                'Book Keeping': 'B-KEEP',
                'Civics': 'CIV'
            };
            return abbreviations[subject] || subject;
        }

        function getSubjectRemarks(grade) {
            switch (grade) {
                case 'A': return 'Excellent';
                case 'B': return 'Very Good';
                case 'C': return 'Good';
                case 'D': return 'Satisfactory';
                case 'F': return 'Needs Improvement';
                default: return '-';
            }
        }
function generateGradeSummary(students, results, examType, year) {
    const summary = {
        A: { male: 0, female: 0, total: 0 },
        B: { male: 0, female: 0, total: 0 },
        C: { male: 0, female: 0, total: 0 },
        D: { male: 0, female: 0, total: 0 },
        F: { male: 0, female: 0, total: 0 }
    };

    students.forEach(student => {
        const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
        let totalMarks = 0;
        let validSubjects = 0;
        studentResults.forEach(result => {
            if (result.marks !== null && result.marks !== undefined) {
                totalMarks += parseInt(result.marks);
                validSubjects++;
            }
        });
        if (validSubjects > 0) {
            const averageMarks = totalMarks / validSubjects;
            const overallGrade = getGrade(averageMarks);
            const gender = student.gender.toLowerCase();
            summary[overallGrade][gender]++;
            summary[overallGrade].total++;
        }
    });

    let html = `
        <h3>Overall Grade Summary</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Grade</th>
                        <th>Male</th>
                        <th>Female</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${['A', 'B', 'C', 'D', 'F'].map(grade => `
                        <tr>
                            <td>${grade}</td>
                            <td>${summary[grade].male}</td>
                            <td>${summary[grade].female}</td>
                            <td>${summary[grade].total}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    return html;
}

function generateDivisionSummaryTable(students, examType, year) {
    const divisionCounts = {
        I: { male: 0, female: 0, total: 0 },
        II: { male: 0, female: 0, total: 0 },
        III: { male: 0, female: 0, total: 0 },
        IV: { male: 0, female: 0, total: 0 },
        FAIL: { male: 0, female: 0, total: 0 }
    };

    students.forEach(student => {
        const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
        const points = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            return result && ['A', 'B', 'C', 'D', 'F'].includes(getGrade(result.marks)) ? getPoints(getGrade(result.marks)) : null;
        }).filter(p => p !== null);
        const division = getDivision(points);
        const gender = student.gender.toLowerCase();
        divisionCounts[division][gender]++;
        divisionCounts[division].total++;
    });

    let html = `
        <h3>Division Summary</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Division</th>
                        <th>Male</th>
                        <th>Female</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>I</td>
                        <td>${divisionCounts['I'].male}</td>
                        <td>${divisionCounts['I'].female}</td>
                        <td>${divisionCounts['I'].total}</td>
                    </tr>
                    <tr>
                        <td>II</td>
                        <td>${divisionCounts['II'].male}</td>
                        <td>${divisionCounts['II'].female}</td>
                        <td>${divisionCounts['II'].total}</td>
                    </tr>
                    <tr>
                        <td>III</td>
                        <td>${divisionCounts['III'].male}</td>
                        <td>${divisionCounts['III'].female}</td>
                        <td>${divisionCounts['III'].total}</td>
                    </tr>
                    <tr>
                        <td>IV</td>
                        <td>${divisionCounts['IV'].male}</td>
                        <td>${divisionCounts['IV'].female}</td>
                        <td>${divisionCounts['IV'].total}</td>
                    </tr>
                    <tr>
                        <td>FAIL</td>
                        <td>${divisionCounts['FAIL'].male}</td>
                        <td>${divisionCounts['FAIL'].female}</td>
                        <td>${divisionCounts['FAIL'].total}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    return html;
}
        function detectGender(fullName) {
            const firstName = fullName.split(' ')[0].toLowerCase();
            if (maleNames.some(name => firstName.includes(name.toLowerCase()))) return 'Male';
            if (femaleNames.some(name => firstName.includes(name.toLowerCase()))) return 'Female';
            return 'Male';
        }

        function getMonthName(date) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return months[date.getMonth()];
        }

        function getTermFromExamType(examType) {
            const termMap = {
                'Midterm': 'First Term',
                'Terminal': 'Second Term',
                'Annual': 'Third Term',
                'Weekly Test': 'Weekly',
                'Mock': 'Mock',
                'Pre-National': 'Pre-National',
                'Classes Test': 'Class Test',
                'Other Exam': 'Other'
            };
            return termMap[examType] || 'Unknown';
        }

        function showSection(sectionId, showBtnId, hideBtnId) {
            const section = document.getElementById(sectionId);
            const showBtn = document.getElementById(showBtnId);
            const hideBtn = document.getElementById(hideBtnId);
            if (section && showBtn && hideBtn) {
                section.style.display = 'block';
                showBtn.style.display = 'none';
                hideBtn.style.display = 'inline-block';
            }
        }

        function hideSection(sectionId, showBtnId, hideBtnId) {
            const section = document.getElementById(sectionId);
            const showBtn = document.getElementById(showBtnId);
            const hideBtn = document.getElementById(hideBtnId);
            if (section && showBtn && hideBtn) {
                section.style.display = 'none';
                showBtn.style.display = 'inline-block';
                hideBtn.style.display = 'none';
            }
        }

        function goBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop();
                const previousTab = navigationHistory[navigationHistory.length - 1];
                openTab(previousTab);
            } else {
                openTab('home');
            }
        }

        function openTab(tabName) {
    if (!visibleFeatures[tabName] && tabName !== 'home' && tabName !== 'academic') {
        showNotification('Information', 'This feature is disabled by the Academic Office.', 'error');
        return;
    }
    const tabContents = document.querySelectorAll('.tab-content');
    const tabItems = document.querySelectorAll('.tab-item');
    tabContents.forEach(tab => tab.classList.remove('active'));
    tabItems.forEach(item => item.classList.remove('active'));
    const tabContent = document.getElementById(tabName);
    const tabItem = document.querySelector(`.tab-item[data-tab="${tabName}"]`);
    if (tabContent && tabItem) {
        tabContent.classList.add('active');
        tabItem.classList.add('active');
        if (!navigationHistory.includes(tabName)) {
            navigationHistory.push(tabName);
        }
        if (tabName === 'home') loadAnnouncements();
        if (tabName === 'resultsEntry') {
            currentTeacher = null; // Force re-authentication
            checkTeacherAccess();
        } else {
            // Clear currentTeacher when navigating away
            if (currentTeacher) {
                currentTeacher = null;
                document.getElementById('teacherAuthPanel').style.display = 'block';
                document.getElementById('resultsEntryPanel').style.display = 'none';
                document.getElementById('editResultsPanel').style.display = 'none';
            }
        }
        if (tabName === 'sms') loadStudentsForSMS();
    }
}
        function checkTeacherAccess() {
            const teacherAuthPanel = document.getElementById('teacherAuthPanel');
            const resultsEntryPanel = document.getElementById('resultsEntryPanel');
            const editResultsPanel = document.getElementById('editResultsPanel');
            if (teacherAuthPanel && resultsEntryPanel && editResultsPanel) {
                if (currentAcademic) {
                    teacherAuthPanel.style.display = 'none';
                    resultsEntryPanel.style.display = 'block';
                    editResultsPanel.style.display = 'block';
                    populateSubjectOptions();
                    const resultSubject = document.getElementById('resultSubject');
                    if (resultSubject) resultSubject.disabled = false;
                } else {
                    teacherAuthPanel.style.display = currentTeacher ? 'none' : 'block';
                    resultsEntryPanel.style.display = currentTeacher ? 'block' : 'none';
                    editResultsPanel.style.display = currentTeacher ? 'block' : 'none';
                    if (currentTeacher) {
                        const resultSubject = document.getElementById('resultSubject');
                        if (resultSubject) {
                            resultSubject.disabled = true;
                            resultSubject.innerHTML = `<option value="${currentTeacher.subject}">${currentTeacher.subject}</option>`;
                        }
                    }
                }
            }
        }

        function populateSubjectOptions() {
    const subjectSelect = document.getElementById('resultSubject');
    const editSubjectSelect = document.getElementById('editResultSubject');

    if (subjectSelect) {
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        if (currentTeacher && !currentAcademic) {
            const option = document.createElement('option');
            option.value = currentTeacher.subject;
            option.textContent = currentTeacher.subject;
            subjectSelect.appendChild(option);
            subjectSelect.disabled = true;
            subjectSelect.value = currentTeacher.subject;
        } else if (currentAcademic) {
            getSubjects().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            subjectSelect.disabled = false;
        }
        subjectSelect.addEventListener('change', updateResultsTable);
    }

    if (editSubjectSelect) {
        editSubjectSelect.innerHTML = '<option value="">Select Subject</option>';
        if (currentTeacher && !currentAcademic) {
            const option = document.createElement('option');
            option.value = currentTeacher.subject;
            option.textContent = currentTeacher.subject;
            editSubjectSelect.appendChild(option);
            editSubjectSelect.disabled = true;
            editSubjectSelect.value = currentTeacher.subject;
        } else if (currentAcademic) {
            getSubjects().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                editSubjectSelect.appendChild(option);
            });
            editSubjectSelect.disabled = false;
        }
        editSubjectSelect.addEventListener('change', loadEditResults);
    }
}
        function registerStudents(event) {
            event.preventDefault();
            const studentNames = document.getElementById('studentNames').value.split('\n').map(name => name.trim()).filter(name => name);
            const studentClass = document.getElementById('class').value;
            const stream = document.getElementById('stream').value;
            const year = document.getElementById('year').value;
            const regDate = document.getElementById('regDate').value;
            const takesBusinessStudy = document.getElementById('takesBusinessStudy').checked;

            if (!studentNames.length || !studentClass || !stream || !year || !regDate) {
                showNotification('Information', 'Please fill all form fields!', 'error');
                return;
            }

            const updates = {};
            studentNames.forEach(name => {
                if (students.some(s => s.fullName === name && s.class === studentClass && s.stream === stream && s.year === year)) {
                    showNotification('Information', `Name ${name} is already registered!`, 'error');
                    return;
                }

                const studentRef = database.ref('students').push();
                const studentData = {
                    fullName: name,
                    class: studentClass,
                    stream,
                    year,
                    regDate,
                    subjectsTaken: takesBusinessStudy ? ['Business Study'] : [],
                    gender: detectGender(name),
                    phoneNumber: ''
                };
                updates[studentRef.key] = studentData;
                students.push({ id: studentRef.key, ...studentData });
            });

            database.ref('students').update(updates).then(() => {
                showNotification('Success', 'Students registered successfully!', 'success');
                document.getElementById('registrationForm').reset();
            }).catch(error => {
                showNotification('Error', `Failed to register students: ${error.message}`, 'error');
            });
        }

        function searchStudent() {
    console.log('Searching student');
    const searchName = document.getElementById('searchStudentName').value.trim();
    const examType = document.getElementById('searchExamType').value;
    const searchResultsDiv = document.getElementById('searchResults');

    if (!searchName) {
        showNotification('Information', 'Please enter a student name!', 'error');
        return;
    }

    const matchedStudents = students
        .filter(s => s.fullName.toLowerCase().includes(searchName.toLowerCase()))
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!matchedStudents.length) {
        searchResultsDiv.innerHTML = '<p>No students found!</p>';
        return;
    }

    let html = '<h3>Search Results</h3><div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Class</th><th>Stream</th><th>Year</th><th>Phone Number</th><th>Gender</th><th>Update Gender</th><th>Update Phone</th></tr></thead><tbody>';
    matchedStudents.forEach(student => {
        const phoneNumber = student.phoneNumber || '';
        html += `
            <tr>
                <td>${student.fullName}</td>
                <td>${student.class}</td>
                <td>${student.stream}</td>
                <td>${student.year}</td>
                <td>
                    <input type="text" class="phone-input" value="${phoneNumber}" data-student-id="${student.id}" placeholder="Enter phone number">
                </td>
                <td>${student.gender}</td>
                <td>
                    <select onchange="updateGender('${student.id}', this.value)">
                        <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="updatePhoneNumber('${student.id}')">Update</button>
                </td>
            </tr>
        `;
        if (examType) {
            const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType);
            if (studentResults.length) {
                html += '<tr><td colspan="8"><strong>Results:</strong><br>';
                studentResults.forEach(r => {
                    html += `${r.subject}: ${r.marks} (${getGrade(r.marks)})<br>`;
                });
                html += '</td></tr>';
            }
        }
    });
    html += '</tbody></table></div>';
    searchResultsDiv.innerHTML = html;

    document.querySelectorAll('.phone-input').forEach(input => {
        input.addEventListener('input', function () {
            const studentId = this.getAttribute('data-student-id');
            const phoneNumber = this.value.trim();
            students.find(s => s.id === studentId).phoneNumber = phoneNumber;
        });
    });
}

function updateGender(studentId, gender) {
    console.log(`Updating gender for student ID: ${studentId}`);
    database.ref(`students/${studentId}`).update({ gender })
        .then(() => {
            const student = students.find(s => s.id === studentId);
            if (student) student.gender = gender;
            showNotification('Success', 'Gender updated successfully!', 'success');
        })
        .catch(error => {
            showNotification('Error', `Failed to update gender: ${error.message}`, 'error');
        });
}

function updatePhoneNumber(studentId) {
    console.log(`Updating phone number for student ID: ${studentId}`);
    const input = document.querySelector(`input[data-student-id="${studentId}"]`);
    const phoneNumber = input.value.trim();

    if (!phoneNumber.match(/^\+?\d{10,12}$/)) {
        showNotification('Information', 'Please enter a valid phone number!', 'error');
        return;
    }

    database.ref(`students/${studentId}`).update({ phoneNumber })
        .then(() => {
            const student = students.find(s => s.id === studentId);
            if (student) student.phoneNumber = phoneNumber;
            showNotification('Success', 'Phone number updated successfully!', 'success');
        })
        .catch(error => {
            showNotification('Error', `Failed to update phone number: ${error.message}`, 'error');
        });
}

function viewStudents() {
    console.log('Viewing students');
    const studentClass = document.getElementById('studentClass').value;
    const stream = document.getElementById('studentStream').value;
    const year = document.getElementById('studentYear').value;
    const studentListDiv = document.getElementById('studentList');

    if (!studentClass || !stream || !year) {
        showNotification('Information', 'Please select class, stream, and year!', 'error');
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!filteredStudents.length) {
        studentListDiv.innerHTML = '<p>No students found!</p>';
        return;
    }

    let html = '<h3>Student List</h3><div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Class</th><th>Stream</th><th>Year</th><th>Phone Number</th><th>Gender</th><th>Update Gender</th><th>Update Phone</th></tr></thead><tbody>';
    filteredStudents.forEach(student => {
        const phoneNumber = student.phoneNumber || '';
        html += `
            <tr>
                <td>${student.fullName}</td>
                <td>${student.class}</td>
                <td>${student.stream}</td>
                <td>${student.year}</td>
                <td>
                    <input type="text" class="phone-input" value="${phoneNumber}" data-student-id="${student.id}" placeholder="Enter phone number">
                </td>
                <td>${student.gender}</td>
                <td>
                    <select onchange="updateGender('${student.id}', this.value)">
                        <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="updatePhoneNumber('${student.id}')">Update</button>
                </td>
            </tr>
        `;
    });
    html += '</tbody></table></div>';
    studentListDiv.innerHTML = html;

    showSection('studentList', 'showStudentListBtn', 'hideStudentListBtn');

    document.querySelectorAll('.phone-input').forEach(input => {
        input.addEventListener('input', function () {
            const studentId = this.getAttribute('data-student-id');
            const phoneNumber = this.value.trim();
            students.find(s => s.id === studentId).phoneNumber = phoneNumber;
        });
    });
}

function loadStudentsForResults() {
    console.log('Loading students for results');
    const studentClass = document.getElementById('resultClass').value;
    const stream = document.getElementById('resultStream').value;
    const year = document.getElementById('resultYear').value;
    const examType = document.getElementById('resultExamType').value;
    const subject = document.getElementById('resultSubject').value;

    if (!studentClass || !stream || !year || !examType || !subject) {
        showNotification('Information', 'Please fill all fields!', 'error');
        return;
    }

    if (!currentTeacher && !currentAcademic) {
        showNotification('Error', 'Please authenticate as a teacher or academic officer!', 'error');
        return;
    }

    if (currentTeacher && currentTeacher.subject !== subject && !currentAcademic) {
        showNotification('Error', 'You can only enter marks for your assigned subject!', 'error');
        return;
    }

    currentStudentsForResults = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!currentStudentsForResults.length) {
        showNotification('Information', 'No students found for the selected criteria!', 'error');
        return;
    }

    tempResults = results.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType &&
        r.subject === subject
    );

    const progressKey = `progress_${studentClass}_${stream}_${year}_${examType}_${subject}`;
    database.ref(`progress/${progressKey}`).once('value', snapshot => {
        const progressData = snapshot.val();
        if (progressData && progressData.tempResults && progressData.tempResults.length > 0) {
            if (confirm('Previous progress found. Do you want to resume?')) {
                currentStudentIndex = progressData.currentStudentIndex || 0;
                tempResults = progressData.tempResults;
            } else {
                currentStudentIndex = 0;
                tempResults = [];
                database.ref(`progress/${progressKey}`).remove();
            }
        } else {
            currentStudentIndex = 0;
            tempResults = [];
        }

        currentStudentsForResults = currentStudentsForResults.filter(student =>
            !tempResults.some(r => r.studentId === student.id)
        );

        updateResultEntryForm();
        updateResultsTable();
        showSection('resultEntryForm', 'showResultEntryFormBtn', 'hideResultEntryFormBtn');
    }).catch(error => {
        showNotification('Error', `Failed to load progress: ${error.message}`, 'error');
    });
}

function updateResultEntryForm() {
    console.log('Updating result entry form');
    const resultEntryForm = document.getElementById('resultEntryForm');
    const currentStudentSpan = document.getElementById('currentStudent');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    if (!resultEntryForm || !currentStudentSpan || !progressBar || !progressText) return;

    if (currentStudentIndex >= currentStudentsForResults.length) {
        showNotification('Success', `All marks for ${document.getElementById('resultSubject').value} have been entered!`, 'success');
        resultEntryForm.style.display = 'none';
        return;
    }

    const student = currentStudentsForResults[currentStudentIndex];
    currentStudentSpan.textContent = student.fullName;
    document.getElementById('marks').value = '';
    const totalStudents = students.filter(s =>
        s.class === document.getElementById('resultClass').value &&
        s.stream === document.getElementById('resultStream').value &&
        s.year === document.getElementById('resultYear').value
    ).length;
    const progress = ((tempResults.length + currentStudentIndex) / totalStudents) * 100;
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${Math.round(progress)}%`;
    progressText.textContent = `Student ${tempResults.length + currentStudentIndex + 1} of ${totalStudents}`;
}

function saveMarks() {
    console.log('Saving marks');
    const marksInput = document.getElementById('marks');
    const marks = parseInt(marksInput.value);
    const student = currentStudentsForResults[currentStudentIndex];
    const subject = document.getElementById('resultSubject').value;
    const studentClass = document.getElementById('resultClass').value;
    const stream = document.getElementById('resultStream').value;
    const year = document.getElementById('resultYear').value;
    const examType = document.getElementById('resultExamType').value;

    if (isNaN(marks) || marks < 0 || marks > 100) {
        showNotification('Information', 'Please enter valid marks (0‚Äì100)!', 'error');
        return;
    }

    const result = {
        studentId: student.id,
        fullName: student.fullName,
        class: studentClass,
        stream,
        year,
        subject,
        examType,
        marks,
        teacher: currentTeacher ? currentTeacher.name : (currentAcademic ? 'Academic Office' : 'Unknown')
    };

    tempResults.push(result);

    const progressKey = `progress_${studentClass}_${stream}_${year}_${examType}_${subject}`;
    database.ref(`progress/${progressKey}`).set({
        currentStudentIndex: currentStudentIndex + 1,
        tempResults
    }).catch(error => {
        showNotification('Error', `Failed to save progress: ${error.message}`, 'error');
    });

    currentStudentIndex++;
    updateResultEntryForm();
    updateResultsTable();
}

function updateResultsTable() {
    console.log('Updating results table');
    const resultsTableDiv = document.getElementById('resultsTable');
    if (!resultsTableDiv) return;

    const studentClass = document.getElementById('resultClass').value;
    const stream = document.getElementById('resultStream').value;
    const year = document.getElementById('resultYear').value;
    const examType = document.getElementById('resultExamType').value;
    const subject = document.getElementById('resultSubject').value;

    const allStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    let html = `<h3>Entered Results for ${subject}</h3><div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Marks</th><th>Grade</th></tr></thead><tbody>`;
    allStudents.forEach(student => {
        const result = tempResults.find(r => r.studentId === student.id && r.subject === subject);
        html += `<tr><td>${student.fullName}</td><td>${result ? result.marks : '-'}</td><td>${result ? getGrade(result.marks) : '-'}</td></tr>`;
    });
    html += '</tbody></table></div>';
    resultsTableDiv.innerHTML = html;

    showSection('resultsTable', 'showResultsTableBtn', 'hideResultsTableBtn');
}

function submitResults() {
    console.log('Submitting results');
    if (!currentTeacher && !currentAcademic) {
        showNotification('Error', 'You must be logged in as a teacher or academic officer to submit results!', 'error');
        return;
    }

    if (!tempResults.length) {
        showNotification('Information', 'No results to submit!', 'error');
        return;
    }

    const updates = {};
    tempResults.forEach(result => {
        const resultRef = database.ref('results').push();
        updates[resultRef.key] = result;
        results.push({ id: resultRef.key, ...result });
    });

    database.ref('results').update(updates).then(() => {
        showNotification('Success', 'Results submitted successfully!', 'success');
        const studentClass = document.getElementById('resultClass').value;
        const stream = document.getElementById('resultStream').value;
        const year = document.getElementById('resultYear').value;
        const examType = document.getElementById('resultExamType').value;
        const subject = document.getElementById('resultSubject').value;
        const progressKey = `progress_${studentClass}_${stream}_${year}_${examType}_${subject}`;
        database.ref(`progress/${progressKey}`).remove();
        tempResults = [];
        currentStudentsForResults = [];
        currentStudentIndex = 0;
        document.getElementById('resultEntryForm').style.display = 'none';
        document.getElementById('resultsTable').style.display = 'none';
        hideSection('resultEntryForm', 'showResultEntryFormBtn', 'hideResultEntryFormBtn');
        hideSection('resultsTable', 'showResultsTableBtn', 'hideResultsTableBtn');
    }).catch(error => {
        showNotification('Error', `Failed to submit results: ${error.message}`, 'error');
    });
}

function loadEditResults() {
    console.log('Loading results to edit');
    const studentClass = document.getElementById('editResultClass').value;
    const stream = document.getElementById('editResultStream').value;
    const year = document.getElementById('editResultYear').value;
    const examType = document.getElementById('editResultExamType').value;
    const subject = document.getElementById('editResultSubject').value;

    if (!studentClass || !stream || !year || !examType || !subject) {
        showNotification('Information', 'Please fill all fields!', 'error');
        return;
    }

    if (currentTeacher && currentTeacher.subject !== subject && !currentAcademic) {
        showNotification('Error', 'You can only edit marks for your assigned subject!', 'error');
        return;
    }

    const filteredResults = results.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType &&
        r.subject === subject
    );

    if (!filteredResults.length) {
        showNotification('Information', 'No results found for the selected criteria!', 'error');
        document.getElementById('editResultsTable').style.display = 'none';
        return;
    }

    let html = '<h3>Edit Results</h3><div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Marks</th><th>Grade</th><th>Edit</th></tr></thead><tbody>';
    filteredResults.forEach(result => {
        html += `<tr><td>${result.fullName}</td><td><input type="number" min="0" max="100" value="${result.marks}" data-result-id="${result.id}"></td><td>${getGrade(result.marks)}</td><td><button class="btn btn-primary" onclick="updateResult('${result.id}')">Update</button></td></tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('editResultsTable').innerHTML = html;

    showSection('editResultsTable', 'showEditResultsTableBtn', 'hideEditResultsTableBtn');
}

function updateResult(resultId) {
    console.log(`Updating result ID: ${resultId}`);
    const marksInput = document.querySelector(`input[data-result-id="${resultId}"]`);
    const newMarks = parseInt(marksInput.value);

    if (isNaN(newMarks) || newMarks < 0 || newMarks > 100) {
        showNotification('Information', 'Please enter valid marks (0‚Äì100)!', 'error');
        return;
    }

    database.ref(`results/${resultId}`).update({ marks: newMarks }).then(() => {
        const result = results.find(r => r.id === resultId);
        if (result) result.marks = newMarks;
        showNotification('Success', 'Result updated successfully!', 'success');
        loadEditResults();
    }).catch(error => {
        showNotification('Error', `Failed to update result: ${error.message}`, 'error');
    });
}

function viewResults() {
    console.log('Viewing results');
    const studentClass = document.getElementById('resultsClass').value;
    const stream = document.getElementById('resultsStream').value;
    const year = document.getElementById('resultsYear').value;
    const examType = document.getElementById('resultsExamType').value;
    const resultsDisplayDiv = document.getElementById('resultsDisplay');
    resultsDisplayDiv.innerHTML = '';

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!filteredStudents.length) {
        showNotification('Information', 'No students found for the selected class and stream!', 'error');
        return;
    }

    const filteredResults = results.filter(r => r.examType === examType && r.year === year);

    const studentResults = filteredStudents.map((student, index) => {
    let totalMarks = 0;
    const row = { 
        student, 
        marks: {}, 
        grades: {}, 
        totalMarks: 0, 
        points: '-', 
        division: '-', 
        overallGrade: '-' 
    };
    const studentResults = filteredResults.filter(r => r.studentId === student.id);
    getSubjects().forEach(subject => {
        const result = studentResults.find(r => r.subject === subject);
        row.marks[subject] = result && result.marks != null ? result.marks : null;
        const grade = result && result.marks != null ? getGrade(result.marks) : '-';
        row.grades[subject] = grade;
        if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(grade)) {
            totalMarks += parseInt(result.marks) || 0;
        }
    });
    row.totalMarks = totalMarks || '-';
    const pointsArray = getSubjects().map(subject => {
        const grade = row.grades[subject];
        return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
    });
    // Calculate points for top 7 subjects
    const validPoints = pointsArray.filter(p => p !== null);
    const edkIndex = getSubjects().indexOf('EDK');
    const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
    const otherPoints = validPoints
        .filter((p, idx) => idx !== edkIndex || edkPoint === null)
        .sort((a, b) => a - b);
    const topPoints = edkPoint !== null 
        ? [edkPoint, ...otherPoints.slice(0, 6)]
        : otherPoints.slice(0, 7);
    row.points = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';
    row.division = getDivision(pointsArray);
    row.overallGrade = getOverallGrade(studentResults);
    return row;
}).sort((a, b) => b.totalMarks - a.totalMarks);
    const divisionSummary = {
        'I': { male: 0, female: 0, total: 0 },
        'II': { male: 0, female: 0, total: 0 },
        'III': { male: 0, female: 0, total: 0 },
        'IV': { male: 0, female: 0, total: 0 },
        'FAIL': { male: 0, female: 0, total: 0 }
    };

    studentResults.forEach(row => {
        const gender = row.student.gender.toLowerCase();
        divisionSummary[row.division][gender]++;
        divisionSummary[row.division].total++;
    });

    let html = `
        <h2>Results for ${studentClass} ${stream} - ${examType} ${year}</h2>
        <div class="table-container">
            <table class="table">
                <thead>
    <tr>
        <th>Position</th>
        <th>Name</th>
        <th>Gender</th>
        ${getSubjects().map(subject => `
            <th>${getSubjectAbbreviation(subject)} Marks</th>
            <th>${getSubjectAbbreviation(subject)} Grade</th>
        `).join('')}
        <th>Total Marks</th>
        <th>Points</th>
        <th>Division</th>
        <th>Overall Grade</th>
    </tr>
</thead>
              <tbody>
    ${studentResults.map((row, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${row.student.fullName}</td>
            <td>${row.student.gender}</td>
            ${getSubjects().map(subject => `
                <td>${row.marks[subject] !== null ? row.marks[subject] : '-'}</td>
                <td>${row.grades[subject]}</td>
            `).join('')}
            <td>${row.totalMarks}</td>
            <td>${row.points}</td>
            <td>${row.division}</td>
            <td>${row.overallGrade}</td>
        </tr>
    `).join('')}
</tbody>
            </table>
        </div>
        <div class="summary-tables">
            <h3>Division Summary</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Division</th>
                        <th>Male</th>
                        <th>Female</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${['I', 'II', 'III', 'IV', 'FAIL'].map(division => `
                        <tr>
                            <td>${division}</td>
                            <td>${divisionSummary[division].male}</td>
                            <td>${divisionSummary[division].female}</td>
                            <td>${divisionSummary[division].total}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ${generateGradeSummary(filteredStudents, filteredResults, examType, year)}
    `;

    resultsDisplayDiv.innerHTML = html;
    showSection('resultsDisplay', 'showResultsDisplayBtn', 'hideResultsDisplayBtn');
}


function printResults() {
    console.log('Printing results');
    const element = document.getElementById('resultsDisplay');
    if (!element.innerHTML) {
        showNotification('Information', 'No results to print!', 'error');
        return;
    }

    const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: `Bismarck_Results_${document.getElementById('resultsClass').value}_${document.getElementById('resultsStream').value}_${document.getElementById('resultsExamType').value}_${document.getElementById('resultsYear').value}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, width: 900 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    html2pdf().from(element).set(opt).save();
}

function exportToCSV() {
    console.log('Exporting to CSV');
    const studentClass = document.getElementById('resultsClass').value;
    const stream = document.getElementById('resultsStream').value;
    const year = document.getElementById('resultsYear').value;
    const examType = document.getElementById('resultsExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!filteredStudents.length) {
        showNotification('Information', 'No students found!', 'error');
        return;
    }

    let csv = `Name,Gender,${getSubjects().map(subject => getSubjectAbbreviation(subject)).join(',')},Total Marks,Points,Division,Position\n`;
    const studentResults = filteredStudents.map(student => {
    let totalMarks = 0;
    const row = { student, marks: {}, grades: {}, totalMarks: 0, points: '-', division: '-' };
    getSubjects().forEach(subject => {
        const result = results.find(r => r.studentId === student.id && r.examType === examType && r.subject === subject);
        row.marks[subject] = result && result.marks != null ? result.marks : null;
        const grade = result && result.marks != null ? getGrade(result.marks) : '-';
        row.grades[subject] = grade;
        if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(grade)) {
            totalMarks += parseInt(result.marks) || 0;
        }
    });
    row.totalMarks = totalMarks || '-';
    const pointsArray = getSubjects().map(subject => {
        const grade = row.grades[subject];
        return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
    });
    const validPoints = pointsArray.filter(p => p !== null);
    const edkIndex = getSubjects().indexOf('EDK');
    const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
    const otherPoints = validPoints
        .filter((p, idx) => idx !== edkIndex || edkPoint === null)
        .sort((a, b) => a - b);
    const topPoints = edkPoint !== null 
        ? [edkPoint, ...otherPoints.slice(0, 6)]
        : otherPoints.slice(0, 7);
    row.points = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';
    row.division = getDivision(pointsArray);
    return row;
}).sort((a, b) => b.totalMarks - a.totalMarks);
    studentResults.forEach((row, index) => {
        let csvRow = `${row.student.fullName},${row.student.gender},`;
        getSubjects().forEach(subject => {
            csvRow += `${row.grades[subject]},`;
        });
        csvRow += `${row.totalMarks},${row.points},${row.division},${index + 1}\n`;
        csv += csvRow;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Bismarck_Results_${studentClass}_${stream}_${examType}_${year}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportToWord() {
    console.log('Exporting to Word');
    const resultsDisplay = document.getElementById('resultsDisplay');
    if (!resultsDisplay.innerHTML) {
        showNotification('Information', 'No results to export!', 'error');
        return;
    }

    const studentClass = document.getElementById('resultsClass').value;
    const stream = document.getElementById('resultsStream').value;
    const year = document.getElementById('resultsYear').value;
    const examType = document.getElementById('resultsExamType').value;

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    const filteredResults = results.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType &&
        r.studentId &&
        r.subject &&
        r.marks != null
    );

    const data = filteredStudents.map((student, index) => {
        let totalMarks = 0;
        const studentResults = filteredResults.filter(r => r.studentId === student.id);
        const pointsArray = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const grade = result && result.marks != null ? getGrade(result.marks) : null;
            return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
        });

        const subjects = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            return {
                name: getSubjectAbbreviation(subject),
                marks: result && result.marks != null ? result.marks : '-',
                grade: result && result.marks != null ? getGrade(result.marks) : '-'
            };
        });

        getSubjects().forEach(subject => {
            const result = studentResults.find(r => r.subject === subject);
            if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(getGrade(result.marks))) {
                totalMarks += parseInt(result.marks) || 0;
            }
        });

        const validPoints = pointsArray.filter(p => p !== null);
        const edkIndex = getSubjects().indexOf('EDK');
        const edkPoint = pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
        const otherPoints = validPoints
            .filter((p, idx) => idx !== edkIndex)
            .sort((a, b) => a - b);
        const topPoints = edkPoint !== null 
            ? [edkPoint, ...otherPoints.slice(0, 6)]
            : otherPoints.slice(0, 7);
        const totalPoints = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';

        return {
            name: student.fullName,
            gender: student.gender,
            subjects,
            totalMarks: totalMarks || '-',
            points: totalPoints,
            division: getDivision(pointsArray),
            overallGrade: getOverallGrade(studentResults),
            position: index + 1
        };
    });

    const template = `
        <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
            <w:body>
                <w:p><w:r><w:t>Bismarck Secondary School</w:t></w:r></w:p>
                <w:p><w:r><w:t>${studentClass} ${stream} Results - ${examType} ${year}</w:t></w:r></w:p>
                <w:tbl>
                    <w:tblPr>
                        <w:tblW w:w="0" w:type="auto"/>
                        <w:tblBorders>
                            <w:top w:val="single" w:sz="4"/>
                            <w:left w:val="single" w:sz="4"/>
                            <w:bottom w:val="single" w:sz="4"/>
                            <w:right w:val="single" w:sz="4"/>
                            <w:insideH w:val="single" w:sz="4"/>
                            <w:insideV w:val="single" w:sz="4"/>
                        </w:tblBorders>
                    </w:tblPr>
                    <w:tr>
                        <w:tc><w:p><w:r><w:t>Position</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Name</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Gender</w:t></w:r></w:p></w:tc>
                        ${getSubjects().map(subject => `
                            <w:tc><w:p><w:r><w:t>${getSubjectAbbreviation(subject)} Marks</w:t></w:r></w:p></w:tc>
                            <w:tc><w:p><w:r><w:t>${getSubjectAbbreviation(subject)} Grade</w:t></w:r></w:p></w:tc>
                        `).join('')}
                        <w:tc><w:p><w:r><w:t>Total Marks</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Points</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Division</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Overall Grade</w:t></w:r></w:p></w:tc>
                    </w:tr>
                    {#data}
                    <w:tr>
                        <w:tc><w:p><w:r><w:t>{position}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{name}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{gender}</w:t></w:r></w:p></w:tc>
                        {#subjects}
                        <w:tc><w:p><w:r><w:t>{marks}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{grade}</w:t></w:r></w:p></w:tc>
                        {/subjects}
                        <w:tc><w:p><w:r><w:t>{totalMarks}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{points}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{division}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{overallGrade}</w:t></w:r></w:p></w:tc>
                    </w:tr>
                    {/data}
                </w:tbl>
            </w:body>
        </w:document>
    `;

    loadDocxTemplate(template).then(blob => {
        const doc = new docxtemplater(new JSZip(blob)); // Use new JSZip for rendering
        doc.setData({ data });
        try {
            doc.render();
            const out = doc.getZip().generate({ type: 'blob' });
            saveAs(out, `Bismarck_Results_${studentClass}_${stream}_${examType}_${year}.docx`);
        } catch (renderError) {
            showNotification('Error', `Failed to render Word document: ${renderError.message}`, 'error');
        }
    }).catch(error => {
        showNotification('Error', `Failed to export to Word: ${error.message}`, 'error');
    });
}
    
    function viewPastResults() {
    console.log('Viewing past results');
    const studentClass = document.getElementById('pastResultsClass').value;
    const stream = document.getElementById('pastResultsStream').value;
    const year = document.getElementById('pastResultsYear').value;
    const examType = document.getElementById('pastResultsExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        document.getElementById('pastResultsDisplay').innerHTML = '';
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    const filteredResults = pastResults.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType &&
        r.studentId &&
        r.subject &&
        r.marks != null
    );

    if (!filteredStudents.length || !filteredResults.length) {
        showNotification('Information', 'No results found for the selected criteria!', 'error');
        document.getElementById('pastResultsDisplay').innerHTML = '';
        return;
    }

    const studentResults = filteredStudents.map((student, index) => {
        let totalMarks = 0;
        const row = { 
            student, 
            marks: {}, 
            grades: {}, 
            totalMarks: 0, 
            points: '-', 
            division: '-', 
            overallGrade: '-' 
        };
        const studentResults = filteredResults.filter(r => r.studentId === student.id);
        getSubjects().forEach(subject => {
            const result = studentResults.find(r => r.subject === subject);
            row.marks[subject] = result && result.marks != null ? result.marks : null;
            const grade = result && result.marks != null ? getGrade(result.marks) : '-';
            row.grades[subject] = grade;
            if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(grade)) {
                totalMarks += parseInt(result.marks) || 0;
            }
        });
        row.totalMarks = totalMarks || '-';
        const pointsArray = getSubjects().map(subject => {
            const grade = row.grades[subject];
            return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
        });
        // Hesabu pointi za masomo 7 bora
        const validPoints = pointsArray.filter(p => p !== null);
        const edkIndex = getSubjects().indexOf('EDK');
        const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
        const otherPoints = validPoints
            .filter((p, idx) => idx !== edkIndex || edkPoint === null)
            .sort((a, b) => a - b);
        const topPoints = edkPoint !== null 
            ? [edkPoint, ...otherPoints.slice(0, 6)]
            : otherPoints.slice(0, 7);
        row.points = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';
        row.division = getDivision(pointsArray);
        row.overallGrade = getOverallGrade(studentResults);
        return row;
    }).sort((a, b) => b.totalMarks - a.totalMarks);
    let html = `
        <h3>Past Results: ${studentClass} ${stream} - ${examType} ${year}</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Name</th>
                        <th>Gender</th>
                        ${getSubjects().map(subject => `
                            <th>${getSubjectAbbreviation(subject)} Marks</th>
                            <th>${getSubjectAbbreviation(subject)} Grade</th>
                        `).join('')}
                        <th>Total Marks</th>
                        <th>Points</th>
                        <th>Division</th>
                        <th>Overall Grade</th>
                    </tr>
                </thead>
                <tbody>
                    ${studentResults.map((row, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${row.student.fullName}</td>
                            <td>${row.student.gender}</td>
                            ${getSubjects().map(subject => `
                                <td>${row.marks[subject] != null ? row.marks[subject] : '-'}</td>
                                <td>${row.grades[subject]}</td>
                            `).join('')}
                            <td>${row.totalMarks}</td>
                            <td>${row.points}</td>
                            <td>${row.division}</td>
                            <td>${row.overallGrade}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ${generateGradeSummary(filteredStudents, filteredResults, examType, year)}
    `;

    document.getElementById('pastResultsDisplay').innerHTML = html;
}

function printPastResults() {
    console.log('Printing past results');
    const element = document.getElementById('pastResultsDisplay');
    if (!element.innerHTML) {
        showNotification('Information', 'No past results to print!', 'error');
        return;
    }

    const opt = {
        margin: 0.5,
        filename: `Bismarck_Past_Results_${document.getElementById('pastResultsClass').value}_${document.getElementById('pastResultsStream').value}_${document.getElementById('pastResultsExamType').value}_${document.getElementById('pastResultsYear').value}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().from(element).set(opt).save();
}

function exportPastToWord() {
    console.log('Exporting past results to Word');
    const pastResultsDisplay = document.getElementById('pastResultsDisplay');
    if (!pastResultsDisplay.innerHTML) {
        showNotification('Information', 'No past results to export!', 'error');
        return;
    }

    const studentClass = document.getElementById('pastResultsClass').value;
    const stream = document.getElementById('pastResultsStream').value;
    const year = document.getElementById('pastResultsYear').value;
    const examType = document.getElementById('pastResultsExamType').value;

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    const filteredResults = pastResults.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType &&
        r.studentId &&
        r.subject &&
        r.marks != null
    );

    if (!filteredStudents.length || !filteredResults.length) {
        showNotification('Information', 'No valid past results to export!', 'error');
        return;
    }

    const data = filteredStudents.map((student, index) => {
        let totalMarks = 0;
        const studentResults = filteredResults.filter(r => r.studentId === student.id);
        const pointsArray = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const grade = result && result.marks != null ? getGrade(result.marks) : null;
            return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
        });

        const subjects = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            return {
                name: getSubjectAbbreviation(subject),
                grade: result && result.marks != null ? getGrade(result.marks) : '-'
            };
        });

        getSubjects().forEach(subject => {
            const result = studentResults.find(r => r.subject === subject);
            if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(getGrade(result.marks))) {
                totalMarks += parseInt(result.marks) || 0;
            }
        });

        const validPoints = pointsArray.filter(p => p !== null);
        const edkIndex = getSubjects().indexOf('EDK');
        const edkPoint = pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
        const otherPoints = validPoints
            .filter((p, idx) => idx !== edkIndex)
            .sort((a, b) => a - b);
        const topPoints = edkPoint !== null 
            ? [edkPoint, ...otherPoints.slice(0, 6)]
            : otherPoints.slice(0, 7);
        const totalPoints = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';

        return {
            name: student.fullName,
            gender: student.gender,
            subjects,
            totalMarks: totalMarks || '-',
            points: totalPoints,
            division: getDivision(pointsArray),
            overallGrade: getOverallGrade(studentResults),
            position: index + 1
        };
    });

    const template = `
        <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
            <w:body>
                <w:p><w:r><w:t>Bismarck Secondary School</w:t></w:r></w:p>
                <w:p><w:r><w:t>Past Results: ${studentClass} ${stream} - ${examType} ${year}</w:t></w:r></w:p>
                <w:tbl>
                    <w:tblPr>
                        <w:tblW w:w="0" w:type="auto"/>
                        <w:tblBorders>
                            <w:top w:val="single" w:sz="4"/>
                            <w:left w:val="single" w:sz="4"/>
                            <w:bottom w:val="single" w:sz="4"/>
                            <w:right w:val="single" w:sz="4"/>
                            <w:insideH w:val="single" w:sz="4"/>
                            <w:insideV w:val="single" w:sz="4"/>
                        </w:tblBorders>
                    </w:tblPr>
                    <w:tr>
                        <w:tc><w:p><w:r><w:t>Position</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Name</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Gender</w:t></w:r></w:p></w:tc>
                        ${getSubjects().map(subject => `
                            <w:tc><w:p><w:r><w:t>${getSubjectAbbreviation(subject)}</w:t></w:r></w:p></w:tc>
                        `).join('')}
                        <w:tc><w:p><w:r><w:t>Total Marks</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Points</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Division</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>Overall Grade</w:t></w:r></w:p></w:tc>
                    </w:tr>
                    {#data}
                    <w:tr>
                        <w:tc><w:p><w:r><w:t>{position}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{name}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{gender}</w:t></w:r></w:p></w:tc>
                        {#subjects}
                        <w:tc><w:p><w:r><w:t>{grade}</w:t></w:r></w:p></w:tc>
                        {/subjects}
                        <w:tc><w:p><w:r><w:t>{totalMarks}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{points}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{division}</w:t></w:r></w:p></w:tc>
                        <w:tc><w:p><w:r><w:t>{overallGrade}</w:t></w:r></w:p></w:tc>
                    </w:tr>
                    {/data}
                </w:tbl>
            </w:body>
        </w:document>
    `;

    loadDocxTemplate(template).then(blob => {
        const doc = new docxtemplater(new JSZip(blob));
        doc.setData({ data });
        try {
            doc.render();
            const out = doc.getZip().generate({ type: 'blob' });
            saveAs(out, `Bismarck_Past_Results_${studentClass}_${stream}_${examType}_${year}.docx`);
        } catch (renderError) {
            showNotification('Error', `Failed to render Word document: ${renderError.message}`, 'error');
        }
    }).catch(error => {
        showNotification('Error', `Failed to export to Word: ${error.message}`, 'error');
    });
}

function loadStudentsForSMS() {
    console.log('Loading students for SMS');
    const studentClass = document.getElementById('smsClass').value;
    const stream = document.getElementById('smsStream').value;
    const year = document.getElementById('smsYear').value;
    const examType = document.getElementById('smsExamType').value;
    const smsStudentListDiv = document.getElementById('smsStudentList');
    const sentCountSpan = document.getElementById('sentCount');
    const pendingCountSpan = document.getElementById('pendingCount');

    if (!studentClass || !stream || !year || !examType || !smsStudentListDiv) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    smsStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year && s.phoneNumber)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!smsStudents.length) {
        smsStudentListDiv.innerHTML = '<p>No students with phone numbers found!</p>';
        sentCountSpan.textContent = '0';
        pendingCountSpan.textContent = '0';
        return;
    }

    const sentStudents = smsStudents.filter(s => sentSMSes.some(sms => sms.studentId === s.id && sms.examType === examType && sms.year === year));
    const pendingStudents = smsStudents.filter(s => !sentSMSes.some(sms => sms.studentId === s.id && sms.examType === examType && sms.year === year));

    sentCountSpan.textContent = sentStudents.length;
    pendingCountSpan.textContent = pendingStudents.length;

    let html = '<h3>Students for SMS</h3><div class="table-container"><table class="table"><thead><tr><th>Select</th><th>Name</th><th>Phone Number</th><th>Status</th><th>Send SMS</th></tr></thead><tbody>';
    smsStudents.forEach(student => {
        const smsSent = sentSMSes.some(s => s.studentId === student.id && s.examType === examType && s.year === year);
        html += `
            <tr>
                <td><input type="checkbox" class="sms-checkbox" data-student-id="${student.id}"></td>
                <td>${student.fullName}</td>
                <td>${student.phoneNumber}</td>
                <td>${smsSent ? '‚úî Sent' : '‚úó Pending'}</td>
                <td>
                    <button class="btn btn-primary" onclick="sendSMS('${student.id}')">Send</button>
                </td>
            </tr>
        `;
    });
    html += '</tbody></table></div>';
    html += '<button class="btn btn-primary" id="sendSelectedSMSBtn">Send SMS to Selected</button>';
    smsStudentListDiv.innerHTML = html;

    const markAllCheckbox = document.getElementById('markAllSMS');
    markAllCheckbox.addEventListener('change', () => {
        document.querySelectorAll('.sms-checkbox').forEach(checkbox => {
            checkbox.checked = markAllCheckbox.checked;
        });
    });

    document.getElementById('sendSelectedSMSBtn').addEventListener('click', sendSelectedSMS);
}

function sendSMS(studentId) {
    console.log(`Sending SMS for student ID: ${studentId}`);
    const student = smsStudents.find(s => s.id === studentId);
    const examType = document.getElementById('smsExamType').value;
    const year = document.getElementById('smsYear').value;
    const studentClass = document.getElementById('smsClass').value;
    const stream = document.getElementById('smsStream').value;

    if (!student || !student.phoneNumber) {
        showNotification('Information', 'No phone number available!', 'error');
        return;
    }

    const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
    if (!studentResults.length) {
        showNotification('Information', 'No results available for this student!', 'error');
        return;
    }

    const points = getSubjects().map(subject => {
        const result = studentResults.find(r => r.subject === subject);
        return result && ['A', 'B', 'C', 'D'].includes(getGrade(result.marks)) ? getPoints(getGrade(result.marks)) : null;
    }).filter(p => p !== null);
    const division = getDivision(points);

    let subjectsList = '';
    getSubjects().forEach(subject => {
        const result = studentResults.find(r => r.subject === subject);
        if (result) {
            subjectsList += `${subject}: ${getGrade(result.marks)}\n`;
        }
    });

    const message = `Bismarck Secondary School\n` +
                `----------------------------------------\n` +
                `TAARIFA YA MATOKEO YA MTIHANI\n\n` +
                `Ndugu Mzazi/Mlezi,\n\n` +
                `Tunapenda kukujulisha matokeo ya mwanafunzi wako kama ifuatavyo:\n\n` +
                `Jina: ${student.fullName}\n` +
                `Darasa: ${studentClass} ${stream}\n` +
                `Mtihani: ${examType} - ${year}\n\n` +
                `Matokeo ya Masomo:\n${subjectsList}\n` +
                `Jumla: Division ${division}\n\n` +
                `Tunaipongeza familia kwa mafanikio haya. Tunaendelea kuhimiza ushirikiano wa karibu kati ya shule na mzazi/mlezi ili kuhakikisha maendeleo bora zaidi kwa mwanafunzi.\n\n` +
                `Kwa maelezo zaidi, tafadhali wasiliana na ofisi ya shule.\n\n` +
                `Wako kwa huduma,\n` +
                `Mwalimu Mkuu\n` +
                `Bismarck Secondary School\n` +
                `----------------------------------------`;

    const smsUrl = `sms:${student.phoneNumber}?body=${encodeURIComponent(message)}`;
    window.location.href = smsUrl;

    sentSMSes.push({ studentId, examType, year });
    database.ref('sms').push({ studentId, phoneNumber: student.phoneNumber, message, examType, year, timestamp: new Date().toISOString() })
        .then(() => {
            showNotification('Success', `SMS prepared for ${student.phoneNumber}!`, 'success');
            loadStudentsForSMS();
        })
        .catch(error => {
            showNotification('Error', `Failed to record SMS: ${error.message}`, 'error');
        });
}

function sendSelectedSMS() {
    console.log('Sending SMS to selected students');
    const checkboxes = document.querySelectorAll('.sms-checkbox:checked');
    if (!checkboxes.length) {
        showNotification('Information', 'No students selected!', 'error');
        return;
    }

    checkboxes.forEach((checkbox, index) => {
        const studentId = checkbox.getAttribute('data-student-id');
        setTimeout(() => {
            sendSMS(studentId);
        }, index * 1000); // Delay to prevent browser overload
    });
}

function exportStudentReportToWord(studentId) {
    console.log('exportStudentReportToWord called for student ID:', studentId);
    if (typeof docx === 'undefined') {
        console.error('docx library is not loaded');
        showNotification('Error', 'Word export library (docx) is not loaded. Check your internet connection or script tags.', 'error');
        return;
    }

    const reportContainer = document.querySelector(`.report-container[data-student-id="${studentId}"]`);
    if (!reportContainer) {
        showNotification('Error', 'Report not found!', 'error');
        return;
    }

    const student = students.find(s => s.id === studentId);
    const examType = document.getElementById('reportExamType')?.value || 'Unknown';
    const year = document.getElementById('reportYear')?.value || 'Unknown';
    const filename = student ? `Bismarck_Report_${student.fullName}_${examType}_${year}.docx` : `Bismarck_Report_${studentId}_${examType}_${year}.docx`;

    // Extract report data
    const header = reportContainer.querySelector('.print-header').innerText.trim();
    const studentDetails = Array.from(reportContainer.querySelectorAll('.report-table')[0].rows).map(row => ({
        key: row.cells[0].innerText.trim(),
        value: row.cells[1].innerText.trim()
    }));
    const academicPerformance = Array.from(reportContainer.querySelectorAll('.report-table')[1].rows).slice(1).map(row => ({
        subject: row.cells[0].innerText.trim(),
        grade: row.cells[1].innerText.trim(),
        remarks: row.cells[2].innerText.trim()
    }));
    const conduct = Array.from(reportContainer.querySelectorAll('.report-table')[2].rows).slice(1).map(row => ({
        criteria: row.cells[0].innerText.trim(),
        grade: row.cells[1].innerText.trim()
    }));
    const footerParas = Array.from(reportContainer.querySelectorAll('.report-footer p')).map(p => p.innerText.trim());

    // Create Word document
    const doc = new docx.Document({
        sections: [{
            properties: {
                page: {
                    margin: { top: 720, bottom: 720, left: 720, right: 720 },
                    size: { width: 12240, height: 15840 } // A4 in twips
                }
            },
            children: [
                new docx.Paragraph({
                    text: header,
                    heading: docx.HeadingLevel.HEADING_1,
                    alignment: docx.AlignmentType.CENTER,
                    spacing: { after: 200 }
                }),
                new docx.Paragraph({
                    text: "Student Details",
                    heading: docx.HeadingLevel.HEADING_2,
                    spacing: { before: 400, after: 200 }
                }),
                new docx.Table({
                    width: { size: 100, type: docx.WidthType.PERCENTAGE },
                    borders: {
                        top: { style: docx.BorderStyle.SINGLE, size: 1 },
                        bottom: { style: docx.BorderStyle.SINGLE, size: 1 },
                        left: { style: docx.BorderStyle.SINGLE, size: 1 },
                        right: { style: docx.BorderStyle.SINGLE, size: 1 }
                    },
                    rows: studentDetails.map(item => new docx.TableRow({
                        children: [
                            new docx.TableCell({
                                children: [new docx.Paragraph({ text: item.key, bold: true })],
                                margins: { top: 100, bottom: 100, left: 100, right: 100 }
                            }),
                            new docx.TableCell({
                                children: [new docx.Paragraph(item.value)],
                                margins: { top: 100, bottom: 100, left: 100, right: 100 }
                            })
                        ]
                    }))
                }),
                new docx.Paragraph({
                    text: "Academic Performance",
                    heading: docx.HeadingLevel.HEADING_2,
                    spacing: { before: 400, after: 200 }
                }),
                new docx.Table({
                    width: { size: 100, type: docx.WidthType.PERCENTAGE },
                    borders: {
                        top: { style: docx.BorderStyle.SINGLE, size: 1 },
                        bottom: { style: docx.BorderStyle.SINGLE, size: 1 },
                        left: { style: docx.BorderStyle.SINGLE, size: 1 },
                        right: { style: docx.BorderStyle.SINGLE, size: 1 }
                    },
                    rows: [
                        new docx.TableRow({
                            children: [
                                new docx.TableCell({
                                    children: [new docx.Paragraph({ text: "Subject", bold: true })],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph({ text: "Grade", bold: true })],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph({ text: "Remarks", bold: true })],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                })
                            ]
                        }),
                        ...academicPerformance.map(item => new docx.TableRow({
                            children: [
                                new docx.TableCell({
                                    children: [new docx.Paragraph(item.subject)],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph(item.grade)],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph(item.remarks)],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                })
                            ]
                        }))
                    ]
                }),
                new docx.Paragraph({
                    text: "Behavior and Conduct",
                    heading: docx.HeadingLevel.HEADING_2,
                    spacing: { before: 400, after: 200 }
                }),
                new docx.Table({
                    width: { size: 100, type: docx.WidthType.PERCENTAGE },
                    borders: {
                        top: { style: docx.BorderStyle.SINGLE, size: 1 },
                        bottom: { style: docx.BorderStyle.SINGLE, size: 1 },
                        left: { style: docx.BorderStyle.SINGLE, size: 1 },
                        right: { style: docx.BorderStyle.SINGLE, size: 1 }
                    },
                    rows: [
                        new docx.TableRow({
                            children: [
                                new docx.TableCell({
                                    children: [new docx.Paragraph({ text: "Criteria", bold: true })],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph({ text: "Grade", bold: true })],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                })
                            ]
                        }),
                        ...conduct.map(item => new docx.TableRow({
                            children: [
                                new docx.TableCell({
                                    children: [new docx.Paragraph(item.criteria)],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                }),
                                new docx.TableCell({
                                    children: [new docx.Paragraph(item.grade)],
                                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                                })
                            ]
                        }))
                    ]
                }),
                new docx.Paragraph({
                    text: "Report Footer",
                    heading: docx.HeadingLevel.HEADING_2,
                    spacing: { before: 400, after: 200 }
                }),
                ...footerParas.map(text => new docx.Paragraph({
                    text,
                    spacing: { before: 100 }
                }))
            ]
        }]
    });

    docx.Packer.toBlob(doc).then(blob => {
        saveAs(blob, filename); // Use FileSaver.js
        showNotification('Success', 'Report exported as Word!', 'success');
    }).catch(error => {
        console.error('Word export error:', error);
        showNotification('Error', `Failed to export report: ${error.message}`, 'error');
    });
}

function generateStudentReports() {
    console.log('Generating student reports');
    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;
    const reportsDisplayDiv = document.getElementById('reportsDisplay');
    reportsDisplayDiv.innerHTML = '';

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Error', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    database.ref(`reports/${studentClass}_${stream}_${year}_${examType}`).once('value', snapshot => {
        const savedReports = snapshot.val() || {};
        console.log('Saved Reports:', savedReports);
        const filteredStudents = students
            .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
            .sort((a, b) => a.fullName.localeCompare(b.fullName));

        if (!filteredStudents.length) {
            showNotification('Error', 'No students found for the selected class and stream!', 'error');
            return;
        }

        const savedCount = Object.keys(savedReports).length;
        const pendingCount = filteredStudents.length - savedCount;

        // Get global comments and dates
        const globalClassTeacherComment = document.getElementById('globalClassTeacherComment')?.value.trim() || '';
        const globalHeadTeacherComment = document.getElementById('globalHeadTeacherComment')?.value.trim() || '';
        const closeDate = document.getElementById('schoolCloseDate')?.value || '';
        const reopenDate = document.getElementById('schoolReopenDate')?.value || '';

        console.log('Global Inputs:', {
            globalClassTeacherComment,
            globalHeadTeacherComment,
            closeDate,
            reopenDate
        });

        let html = `
            <h2>Student Reports for ${studentClass} ${stream} - ${examType} ${year}</h2>
            <p>Saved Reports: ${savedCount} | Pending Reports: ${pendingCount}</p>
            <div class="global-comments">
                <h3>Global Comments and Dates</h3>
                <p>
                    <label>Class Teacher Comment:</label>
                    <textarea id="globalClassTeacherComment" placeholder="Enter class teacher comment">${globalClassTeacherComment}</textarea>
                </p>
                <p>
                    <label>Head Teacher Comment:</label>
                    <textarea id="globalHeadTeacherComment" placeholder="Enter head teacher comment">${globalHeadTeacherComment}</textarea>
                </p>
                <p>
                    <label>School Closure Date:</label>
                    <input type="date" id="schoolCloseDate" value="${closeDate}">
                </p>
                <p>
                    <label>School Reopening Date:</label>
                    <input type="date" id="schoolReopenDate" value="${reopenDate}">
                </p>
                <button class="btn btn-primary" onclick="applyGlobalCommentsAndDates()">Apply Global Comments and Dates</button>
            </div>
        `;

        filteredStudents.forEach(student => {
            const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
            const subjects = Array.isArray(getSubjects()) ? getSubjects() : ['Math', 'English', 'EDK', 'Physics', 'Chemistry', 'Biology', 'History'];
            const pointsArray = subjects.map(subject => {
                const result = studentResults.find(r => r.subject === subject);
                return result && ['A', 'B', 'C', 'D', 'F'].includes(getGrade(result.marks)) ? getPoints(getGrade(result.marks)) : null;
            });

            console.log(`Points Array for ${student.id}:`, pointsArray);

            const term = getTermFromExamType(examType);
            const month = new Date().toLocaleString('default', { month: 'long' });

            // Initialize default conduct
            const defaultConduct = {
                usafi: 'A',
                uaminifu: 'B',
                michezo: 'B',
                nidhamu: 'B',
                kazi: 'B',
                utunzaji_mali: 'B',
                uongozi: 'B'
            };

            // Use saved data if available, otherwise global inputs
            const reportData = savedReports[student.id] || {
                conduct: defaultConduct,
                classTeacherComment: globalClassTeacherComment,
                headTeacherComment: globalHeadTeacherComment,
                closeDate: closeDate,
                reopenDate: reopenDate
            };

            // Ensure conduct is defined
            reportData.conduct = reportData.conduct || defaultConduct;

            // Prioritize global comments
            reportData.classTeacherComment = (savedReports[student.id]?.classTeacherComment?.trim() || globalClassTeacherComment) || '';
            reportData.headTeacherComment = (savedReports[student.id]?.headTeacherComment?.trim() || globalHeadTeacherComment) || '';

            console.log(`Report Data for ${student.id}:`, reportData);

            const isSaved = !!savedReports[student.id];

            // Calculate total points
            const validPoints = pointsArray.filter(p => p !== null);
            const edkIndex = subjects.indexOf('EDK');
            const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
            const otherPoints = validPoints
                .filter((p, idx) => idx !== edkIndex)
                .sort((a, b) => a - b);
            const topPoints = edkPoint !== null
                ? [edkPoint, ...otherPoints.slice(0, 6)]
                : otherPoints.slice(0, 7);
            const totalPoints = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';

            html += `
                <div class="report-container" data-student-id="${student.id}">
                    <div class="print-header">
                        <h1>HALMASHAURI YA JIJI LA MWANZA</h1>
                        <h2>SHULE YA SEKONDARI BISMARCK</h2>
                        <p>RIPOTI YA MWANAFUNZI YA MATOKEO YA ${examType.toUpperCase()} MHULA NA MWEZI ${term.toUpperCase()} ${month.toUpperCase()}</p>
                        <p>Status: ${isSaved ? '‚úî Saved' : '‚úó Not Saved'}</p>
                    </div>
                    <h3>Student Details</h3>
                    <table class="report-table">
                        <tr><th>Name</th><td>${student.fullName}</td></tr>
                        <tr><th>Term</th><td>${term}</td></tr>
                        <tr><th>Division</th><td>${getDivision(pointsArray)}</td></tr>
                        <tr><th>Points</th><td>${totalPoints}</td></tr>
                        <tr><th>Grade</th><td>${getOverallGrade(pointsArray)}</td></tr>
                        <tr><th>Class</th><td>${student.class} ${student.stream}</td></tr>
                    </table>
                    <h3>Academic Performance</h3>
                    <table class="report-table">
                        <thead>
                            <tr><th>Subject</th><th>Grade</th><th>Remarks</th></tr>
                        </thead>
                        <tbody>
                            ${subjects.map(subject => {
                                const result = studentResults.find(r => r.subject === subject);
                                const grade = result ? getGrade(result.marks) : '-';
                                return `
                                    <tr>
                                        <td>${subject}</td>
                                        <td>${grade}</td>
                                        <td>${getSubjectRemarks(grade)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <h3>Behavior and Conduct</h3>
                    <table class="report-table">
                        <thead>
                            <tr><th>Criteria</th><th>Grade</th></tr>
                        </thead>
                        <tbody>
                            ${['Usafi', 'Uaminifu', 'Michezo', 'Nidhamu', 'Kazi', 'Utunzaji Mali', 'Uongozi'].map(criteria => `
                                <tr>
                                    <td>${criteria}</td>
                                    <td>${reportData.conduct[criteria.toLowerCase().replace(' ', '_')] || 'B'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="report-footer">
                        <p>SHULE UMEFUNGWA TAREHE: ${reportData.closeDate || 'Not set'}</p>
                        <p>SHULE ITAFUNGULIWA TAREHE: ${reportData.reopenDate || 'Not set'}</p>
                        <p>MAONI YA MWALIMU WA DARASA: ${reportData.classTeacherComment || 'Not set'}</p>
                        <p>SAHIHI YA MWALIMU WA DARASA: ___________________________</p>
                        <p>MAONI YA MWALIMU MKUU: ${reportData.headTeacherComment || 'Not set'}</p>
                        <p>MHURI WA SHULE: ___________________________</p>
                        <button class="btn btn-primary save-report-btn" onclick="saveReport('${student.id}')">Save Report</button>
                        <button class="btn btn-primary print-report-btn" onclick="printStudentReport('${student.id}')">Print Report</button>
                        <button class="btn btn-primary export-word-btn" onclick="exportStudentReportToWord('${student.id}')">Export to Word</button>
                    </div>
                </div>
            `;
        });

        reportsDisplayDiv.innerHTML = html;

        showSection('reportsDisplay', 'showReportsDisplayBtn', 'hideReportsDisplayBtn');
    });
}

function applyGlobalCommentsAndDates() {
    console.log('Applying global comments and dates');
    const globalClassTeacherComment = document.getElementById('globalClassTeacherComment')?.value.trim() || '';
    const globalHeadTeacherComment = document.getElementById('globalHeadTeacherComment')?.value.trim() || '';
    const closeDate = document.getElementById('schoolCloseDate')?.value || '';
    const reopenDate = document.getElementById('schoolReopenDate')?.value || '';

    console.log('Applying Global Inputs:', {
        globalClassTeacherComment,
        globalHeadTeacherComment,
        closeDate,
        reopenDate
    });

    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;
    const filteredStudents = students.filter(s => s.class === studentClass && s.stream === stream && s.year === year);

    const updates = {};
    filteredStudents.forEach(student => {
        updates[`reports/${studentClass}_${stream}_${year}_${examType}/${student.id}/classTeacherComment`] = globalClassTeacherComment;
        updates[`reports/${studentClass}_${stream}_${year}_${examType}/${student.id}/headTeacherComment`] = globalHeadTeacherComment;
        updates[`reports/${studentClass}_${stream}_${year}_${examType}/${student.id}/closeDate`] = closeDate;
        updates[`reports/${studentClass}_${stream}_${year}_${examType}/${student.id}/reopenDate`] = reopenDate;
        updates[`reports/${studentClass}_${stream}_${year}_${examType}/${student.id}/conduct`] = {
            usafi: 'A',
            uaminifu: 'B',
            michezo: 'B',
            nidhamu: 'B',
            kazi: 'B',
            utunzaji_mali: 'B',
            uongozi: 'B'
        };
    });

    database.ref().update(updates)
        .then(() => {
            generateStudentReports();
            showNotification('Success', 'Global comments and dates applied!', 'success');
        })
        .catch(error => {
            showNotification('Error', `Failed to apply comments: ${error.message}`, 'error');
        });
}
    function saveReport(studentId) {
    console.log(`Saving report for student ID: ${studentId}`);
    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;

    const classTeacherComment = document.getElementById('globalClassTeacherComment')?.value.trim() || '';
    const headTeacherComment = document.getElementById('globalHeadTeacherComment')?.value.trim() || '';
    const closeDate = document.getElementById('schoolCloseDate')?.value || '';
    const reopenDate = document.getElementById('schoolReopenDate')?.value || '';

    console.log('Saving Report Data:', {
        classTeacherComment,
        headTeacherComment,
        closeDate,
        reopenDate
    });

    const conduct = {
        usafi: 'A',
        uaminifu: 'B',
        michezo: 'B',
        nidhamu: 'B',
        kazi: 'B',
        utunzaji_mali: 'B',
        uongozi: 'B'
    };

    const reportData = {
        conduct,
        classTeacherComment,
        headTeacherComment,
        closeDate,
        reopenDate
    };

    const container = document.querySelector(`.report-container[data-student-id="${studentId}"]`);
    if (!container) {
        showNotification('Error', 'Report container not found!', 'error');
        return;
    }

    database.ref(`reports/${studentClass}_${stream}_${year}_${examType}/${studentId}`).set(reportData)
        .then(() => {
            showNotification('Success', 'Report saved successfully!', 'success');
            const status = container.querySelector('.print-header p:last-child');
            if (status) status.textContent = 'Status: ‚úî Saved';
            generateStudentReports();
        })
        .catch(error => {
            showNotification('Error', `Failed to save report: ${error.message}`, 'error');
        });
}
function printReports() {
    console.log('Printing student reports');
    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;

    database.ref(`reports/${studentClass}_${stream}_${year}_${examType}`).once('value', snapshot => {
        const savedReports = snapshot.val() || {};
        const reportContainers = document.querySelectorAll('.report-container');
        const savedContainers = Array.from(reportContainers).filter(container => savedReports[container.getAttribute('data-student-id')]);

        if (!savedContainers.length) {
            showNotification('Information', 'No saved reports to print!', 'error');
            return;
        }

        savedContainers.forEach((container, index) => {
            setTimeout(() => {
                const opt = {
                    margin: [0.5, 0.5, 0.5, 0.5],
                    filename: `Bismarck_Report_${container.querySelector('table.report-table td').textContent}_${examType}_${year}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, width: 900 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                    pagebreak: { mode: ['css', 'legacy'], before: '.report-container' }
                };
                html2pdf().from(container).set(opt).save();
            }, index * 1000);
        });
    }).catch(error => {
        showNotification('Error', `Failed to load saved reports: ${error.message}`, 'error');
    });
}
function printStudentReport(studentId) {
    console.log('printStudentReport loaded');
    console.log(`Printing report for student ID: ${studentId}`);
    const reportContainer = document.querySelector(`.report-container[data-student-id="${studentId}"]`);
    if (!reportContainer) {
        showNotification('Error', 'Report not found!', 'error');
        return;
    }

    // Create temporary container
    const printContainer = document.createElement('div');
    printContainer.style.position = 'absolute';
    printContainer.style.top = '-9999px';
    printContainer.style.width = '210mm';
    printContainer.style.padding = '10mm';
    printContainer.style.boxSizing = 'border-box';
    printContainer.style.fontFamily = 'Arial, sans-serif';
    printContainer.innerHTML = reportContainer.innerHTML;

    // Remove buttons
    printContainer.querySelectorAll('.save-report-btn, .print-report-btn, .export-word-btn').forEach(btn => btn.remove());
    printContainer.style.fontSize = '12px';
    printContainer.style.lineHeight = '1.2';
    printContainer.style.display = 'block';
    printContainer.style.visibility = 'visible';

    document.body.appendChild(printContainer);
    console.log('Print Container HTML:', printContainer.outerHTML);

    const examType = document.getElementById('reportExamType')?.value || 'Unknown';
    const year = document.getElementById('reportYear')?.value || 'Unknown';
    const student = students.find(s => s.id === studentId);
    const filename = student ? `Bismarck_Report_${student.fullName}_${examType}_${year}.pdf` : `Bismarck_Report_${studentId}_${examType}_${year}.pdf`;

    const opt = {
        margin: 10,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(printContainer).save()
        .then(() => {
            showNotification('Success', 'Report printed as PDF!', 'success');
            document.body.removeChild(printContainer);
        })
        .catch(error => {
            showNotification('Error', `Failed to print report: ${error.message}`, 'error');
            document.body.removeChild(printContainer);
        });
}
function exportReportsToWord() {
    console.log('Exporting student reports to Word');
    const studentClass = document.getElementById('reportClass')?.value;
    const stream = document.getElementById('reportStream')?.value;
    const year = document.getElementById('reportYear')?.value;
    const examType = document.getElementById('reportExamType')?.value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    database.ref('results').once('value', snapshot => {
        results = [];
        snapshot.forEach(child => {
            const result = child.val();
            if (result.studentId && result.subject && result.marks != null) {
                results.push({ id: child.key, ...result });
            }
        });

        database.ref(`reports/${studentClass}_${stream}_${year}_${examType}`).once('value', snapshot => {
            const savedReports = snapshot.val() || {};
            const reportContainers = document.querySelectorAll('.report-container');
            const savedContainers = Array.from(reportContainers).filter(container => savedReports[container.getAttribute('data-student-id')]);

            if (!savedContainers.length) {
                showNotification('Information', 'No saved reports to export!', 'error');
                return;
            }

            const data = savedContainers.map(container => {
                const studentId = container.getAttribute('data-student-id');
                const student = students.find(s => s.id === studentId);
                if (!student) {
                    return null;
                }
                const studentResults = results.filter(r => r.studentId === studentId && r.examType === examType && r.year === year);
                const reportData = savedReports[studentId];
                const term = getTermFromExamType(examType);
                const month = new Date().toLocaleString('default', { month: 'long' });
                const pointsArray = getSubjects().map(subject => {
                    const result = studentResults.find(r => r.subject === subject);
                    return result && result.marks != null && ['A', 'B', 'C', 'D', 'F'].includes(getGrade(result.marks)) ? getPoints(getGrade(result.marks)) : null;
                });

                const validPoints = pointsArray.filter(p => p !== null);
const edkIndex = getSubjects().indexOf('EDK');
const edkPoint = pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
const otherPoints = validPoints
    .filter((p, idx) => idx !== edkIndex)
    .sort((a, b) => a - b);
const topPoints = edkPoint !== null 
    ? [edkPoint, ...otherPoints.slice(0, 6)]
    : otherPoints.slice(0, 7);
const totalPoints = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';

                return {
                    studentName: student.fullName,
                    term: term,
                    month: month.toUpperCase(),
                    examType: examType.toUpperCase(),
                    division: getDivision(pointsArray),
                    points: totalPoints,
                    grade: getOverallGrade(studentResults),
                    classStream: `${student.class} ${student.stream}`,
                    subjects: getSubjects().map(subject => {
                        const result = studentResults.find(r => r.subject === subject);
                        return {
                            name: subject,
                            grade: result && result.marks != null ? getGrade(result.marks) : '-',
                            remarks: result && result.marks != null ? getSubjectRemarks(getGrade(result.marks)) : '-'
                        };
                    }),
                    conduct: Object.entries(reportData.conduct || {}).map(([criteria, grade]) => ({
                        criteria: criteria.replace('_', ' ').toUpperCase(),
                        grade: grade || '-'
                    })),
                    closeDate: document.getElementById('schoolCloseDate')?.value || '',
             reopenDate: document.getElementById('schoolReopenDate')?.value || '',
                    classTeacherComment: reportData.classTeacherComment || '',
                    headTeacherComment: reportData.headTeacherComment || ''
                };
            }).filter(item => item !== null);

            if (!data.length) {
                showNotification('Information', 'No valid reports to export!', 'error');
                return;
            }

            const template = `
                <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                    <w:body>
                        {#data}
                        <w:p><w:r><w:t>HALMASHAURI YA JIJI LA MWANZA</w:t></w:r></w:p>
                        <w:p><w:r><w:t>SHULE YA SEKONDARI BISMARCK</w:t></w:r></w:p>
                        <w:p><w:r><w:t>RIPOTI YA MWANAFUNZI YA MATOKEO YA {examType} MHULA NA MWEZI {term} {month}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>Student Details</w:t></w:r></w:p>
                        <w:tbl>
                            <w:tblPr>
                                <w:tblW w:w="0" w:type="auto"/>
                                <w:tblBorders>
                                    <w:top w:val="single" w:sz="4"/>
                                    <w:left w:val="single" w:sz="4"/>
                                    <w:bottom w:val="single" w:sz="4"/>
                                    <w:right w:val="single" w:sz="4"/>
                                    <w:insideH w:val="single" w:sz="4"/>
                                    <w:insideV w:val="single" w:sz="4"/>
                                </w:tblBorders>
                            </w:tblPr>
                            <w:tr><w:tc><w:p><w:r><w:t>Name</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{studentName}</w:t></w:r></w:p></w:tc></w:tr>
                            <w:tr><w:tc><w:p><w:r><w:t>Term</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{term}</w:t></w:r></w:p></w:tc></w:tr>
                            <w:tr><w:tc><w:p><w:r><w:t>Division</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{division}</w:t></w:r></w:p></w:tc></w:tr>
                            <w:tr><w:tc><w:p><w:r><w:t>Points</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{points}</w:t></w:r></w:p></w:tc></w:tr>
                            <w:tr><w:tc><w:p><w:r><w:t>Grade</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{grade}</w:t></w:r></w:p></w:tc></w:tr>
                            <w:tr><w:tc><w:p><w:r><w:t>Class</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{classStream}</w:t></w:r></w:p></w:tc></w:tr>
                        </w:tbl>
                        <w:p><w:r><w:t>Academic Performance</w:t></w:r></w:p>
                        <w:tbl>
                            <w:tblPr>
                                <w:tblW w:w="0" w:type="auto"/>
                                <w:tblBorders>
                                    <w:top w:val="single" w:sz="4"/>
                                    <w:left w:val="single" w:sz="4"/>
                                    <w:bottom w:val="single" w:sz="4"/>
                                    <w:right w:val="single" w:sz="4"/>
                                    <w:insideH w:val="single" w:sz="4"/>
                                    <w:insideV w:val="single" w:sz="4"/>
                                </w:tblBorders>
                            </w:tblPr>
                            <w:tr><w:tc><w:p><w:r><w:t>Subject</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>Grade</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>Remarks</w:t></w:r></w:p></w:tc></w:tr>
                            {#subjects}
                            <w:tr><w:tc><w:p><w:r><w:t>{name}</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{grade}</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{remarks}</w:t></w:r></w:p></w:tc></w:tr>
                            {/subjects}
                        </w:tbl>
                        <w:p><w:r><w:t>Behavior and Conduct</w:t></w:r></w:p>
                        <w:tbl>
                            <w:tblPr>
                                <w:tblW w:w="0" w:type="auto"/>
                                <w:tblBorders>
                                    <w:top w:val="single" w:sz="4"/>
                                    <w:left w:val="single" w:sz="4"/>
                                    <w:bottom w:val="single" w:sz="4"/>
                                    <w:right w:val="single" w:sz="4"/>
                                    <w:insideH w:val="single" w:sz="4"/>
                                    <w:insideV w:val="single" w:sz="4"/>
                                </w:tblBorders>
                            </w:tblPr>
                            <w:tr><w:tc><w:p><w:r><w:t>Criteria</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>Grade</w:t></w:r></w:p></w:tc></w:tr>
                            {#conduct}
                            <w:tr><w:tc><w:p><w:r><w:t>{criteria}</w:t></w:r></w:p></w:tc><w:tc><w:p><w:r><w:t>{grade}</w:t></w:r></w:p></w:tc></w:tr>
                            {/conduct}
                        </w:tbl>
                        <w:p><w:r><w:t>SHULE UMEFUNGWA TAREHE: {closeDate}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>SHULE ITAFUNGULIWA TAREHE: {reopenDate}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>MAONI YA MWALIMU WA DARASA: {classTeacherComment}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>SAHIHI YA MWALIMU WA DARASA: ___________________________</w:t></w:r></w:p>
                        <w:p><w:r><w:t>MAONI YA MWALIMU MKUU: {headTeacherComment}</w:t></w:r></w:p>
                        <w:p><w:r><w:t>MHURI WA SHULE: ___________________________</w:t></w:r></w:p>
                        <w:p><w:br w:type="page"/></w:p>
                        {/data}
                    </w:body>
                </w:document>
            `;

            loadDocxTemplate(template).then(blob => {
                const doc = new docxtemplater(new JSZip(blob));
                doc.setData({ data });
                try {
                    doc.render();
                    const out = doc.getZip().generate({ type: 'blob' });
                    saveAs(out, `Bismarck_Student_Reports_${studentClass}_${stream}_${examType}_${year}.docx`);
                } catch (renderError) {
                    showNotification('Error', `Failed to render Word document: ${renderError.message}`, 'error');
                }
            }).catch(error => {
                showNotification('Error', `Failed to export to Word: ${error.message}`, 'error');
            });
        }).catch(error => {
            showNotification('Error', `Failed to load reports: ${error.message}`, 'error');
        });
    }).catch(error => {
        showNotification('Error', `Failed to load results: ${error.message}`, 'error');
    });
}

// Export View Results to Excel
function exportToExcel() {
    console.log('Exporting to Excel');
    const studentClass = document.getElementById('resultsClass').value;
    const stream = document.getElementById('resultsStream').value;
    const year = document.getElementById('resultsYear').value;
    const examType = document.getElementById('resultsExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!filteredStudents.length) {
        showNotification('Information', 'No students found!', 'error');
        return;
    }

    const studentResults = filteredStudents.map((student, index) => {
        let totalMarks = 0;
        const row = { 
            Position: index + 1, 
            Name: student.fullName, 
            Gender: student.gender 
        };
        const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
        getSubjects().forEach(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const abbr = getSubjectAbbreviation(subject);
            row[`${abbr}_Marks`] = result && result.marks != null ? result.marks : '-';
            row[`${abbr}_Grade`] = result && result.marks != null ? getGrade(result.marks) : '-';
            if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(getGrade(result.marks))) {
                totalMarks += parseInt(result.marks) || 0;
            }
        });
        const pointsArray = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const grade = result && result.marks != null ? getGrade(result.marks) : null;
            return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
        });
        const validPoints = pointsArray.filter(p => p !== null);
        const edkIndex = getSubjects().indexOf('EDK');
        const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
        const otherPoints = validPoints
            .filter((p, idx) => idx !== edkIndex || edkPoint === null)
            .sort((a, b) => a - b);
        const topPoints = edkPoint !== null 
            ? [edkPoint, ...otherPoints.slice(0, 6)]
            : otherPoints.slice(0, 7);
        row['Total Marks'] = totalMarks || '-';
        row['Points'] = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';
        row['Division'] = getDivision(pointsArray);
        row['Overall Grade'] = getOverallGrade(studentResults);
        return row;
    });

    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(studentResults);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Results');

    // Add Division Summary
    const divisionSummary = {
        'I': { male: 0, female: 0, total: 0 },
        'II': { male: 0, female: 0, total: 0 },
        'III': { male: 0, female: 0, total: 0 },
        'IV': { male: 0, female: 0, total: 0 },
        'FAIL': { male: 0, female: 0, total: 0 }
    };
    studentResults.forEach(row => {
        const gender = row.Gender.toLowerCase();
        divisionSummary[row.Division][gender]++;
        divisionSummary[row.Division].total++;
    });
    const divisionData = [
        { Division: 'I', Male: divisionSummary['I'].male, Female: divisionSummary['I'].female, Total: divisionSummary['I'].total },
        { Division: 'II', Male: divisionSummary['II'].male, Female: divisionSummary['II'].female, Total: divisionSummary['II'].total },
        { Division: 'III', Male: divisionSummary['III'].male, Female: divisionSummary['III'].female, Total: divisionSummary['III'].total },
        { Division: 'IV', Male: divisionSummary['IV'].male, Female: divisionSummary['IV'].female, Total: divisionSummary['IV'].total },
        { Division: 'FAIL', Male: divisionSummary['FAIL'].male, Female: divisionSummary['FAIL'].female, Total: divisionSummary['FAIL'].total }
    ];
    const divisionWs = XLSX.utils.json_to_sheet(divisionData);
    XLSX.utils.book_append_sheet(wb, divisionWs, 'Division Summary');

    // Add Grade Summary
    const gradeSummary = generateGradeSummary(filteredStudents, results.filter(r => r.examType === examType && r.year === year), examType, year);
    const gradeData = [
        { Grade: 'A', Male: gradeSummary.A.male, Female: gradeSummary.A.female, Total: gradeSummary.A.total },
        { Grade: 'B', Male: gradeSummary.B.male, Female: gradeSummary.B.female, Total: gradeSummary.B.total },
        { Grade: 'C', Male: gradeSummary.C.male, Female: gradeSummary.C.female, Total: gradeSummary.C.total },
        { Grade: 'D', Male: gradeSummary.D.male, Female: gradeSummary.D.female, Total: gradeSummary.D.total },
        { Grade: 'F', Male: gradeSummary.F.male, Female: gradeSummary.F.female, Total: gradeSummary.F.total }
    ];
    const gradeWs = XLSX.utils.json_to_sheet(gradeData);
    XLSX.utils.book_append_sheet(wb, gradeWs, 'Grade Summary');

    // Save file
    XLSX.writeFile(wb, `Bismarck_Results_${studentClass}_${stream}_${examType}_${year}.xlsx`);
}

// Export Past Results to Excel
function exportPastToExcel() {
    console.log('Exporting past results to Excel');
    const studentClass = document.getElementById('pastResultsClass').value;
    const stream = document.getElementById('pastResultsStream').value;
    const year = document.getElementById('pastResultsYear').value;
    const examType = document.getElementById('pastResultsExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    const filteredResults = pastResults.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType &&
        r.studentId &&
        r.subject &&
        r.marks != null
    );

    if (!filteredStudents.length || !filteredResults.length) {
        showNotification('Information', 'No past results found!', 'error');
        return;
    }

    const studentResults = filteredStudents.map((student, index) => {
        let totalMarks = 0;
        const row = { 
            Position: index + 1, 
            Name: student.fullName, 
            Gender: student.gender 
        };
        const studentResults = filteredResults.filter(r => r.studentId === student.id);
        getSubjects().forEach(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const abbr = getSubjectAbbreviation(subject);
            row[`${abbr}_Marks`] = result && result.marks != null ? result.marks : '-';
            row[`${abbr}_Grade`] = result && result.marks != null ? getGrade(result.marks) : '-';
            if (result && result.marks != null && ['A', 'B', 'C', 'D'].includes(getGrade(result.marks))) {
                totalMarks += parseInt(result.marks) || 0;
            }
        });
        const pointsArray = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const grade = result && result.marks != null ? getGrade(result.marks) : null;
            return grade && ['A', 'B', 'C', 'D', 'F'].includes(grade) ? getPoints(grade) : null;
        });
        const validPoints = pointsArray.filter(p => p !== null);
        const edkIndex = getSubjects().indexOf('EDK');
        const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
        const otherPoints = validPoints
            .filter((p, idx) => idx !== edkIndex || edkPoint === null)
            .sort((a, b) => a - b);
        const topPoints = edkPoint !== null 
            ? [edkPoint, ...otherPoints.slice(0, 6)]
            : otherPoints.slice(0, 7);
        row['Total Marks'] = totalMarks || '-';
        row['Points'] = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';
        row['Division'] = getDivision(pointsArray);
        row['Overall Grade'] = getOverallGrade(studentResults);
        return row;
    });

    // Create worksheet
    const ws = XLSX.utils.json_to_sheet(studentResults);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Past Results');

    // Add Grade Summary
    const gradeSummary = generateGradeSummary(filteredStudents, filteredResults, examType, year);
    const gradeData = [
        { Grade: 'A', Male: gradeSummary.A.male, Female: gradeSummary.A.female, Total: gradeSummary.A.total },
        { Grade: 'B', Male: gradeSummary.B.male, Female: gradeSummary.B.female, Total: gradeSummary.B.total },
        { Grade: 'C', Male: gradeSummary.C.male, Female: gradeSummary.C.female, Total: gradeSummary.C.total },
        { Grade: 'D', Male: gradeSummary.D.male, Female: gradeSummary.D.female, Total: gradeSummary.D.total },
        { Grade: 'F', Male: gradeSummary.F.male, Female: gradeSummary.F.female, Total: gradeSummary.F.total }
    ];
    const gradeWs = XLSX.utils.json_to_sheet(gradeData);
    XLSX.utils.book_append_sheet(wb, gradeWs, 'Grade Summary');

    // Save file
    XLSX.writeFile(wb, `Bismarck_Past_Results_${studentClass}_${stream}_${examType}_${year}.xlsx`);
}

// Export Individual Student Report to Excel
function exportStudentReportToExcel(studentId) {
    console.log(`Exporting report for student ID: ${studentId} to Excel`);
    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;
    const student = students.find(s => s.id === studentId);

    if (!student) {
        showNotification('Information', 'Student not found!', 'error');
        return;
    }

    const studentResults = results.filter(r => r.studentId === studentId && r.examType === examType && r.year === year);
    const pointsArray = getSubjects().map(subject => {
        const result = studentResults.find(r => r.subject === subject);
        return result && ['A', 'B', 'C', 'D', 'F'].includes(getGrade(result.marks)) ? getPoints(getGrade(result.marks)) : null;
    });

    const term = getTermFromExamType(examType);
    const month = new Date().toLocaleString('default', { month: 'long' });
    const closeDate = document.getElementById('schoolCloseDate').value || '';
    const reopenDate = document.getElementById('schoolReopenDate').value || '';

    const reportData = database.ref(`reports/${studentClass}_${stream}_${year}_${examType}/${studentId}`).once('value').then(snapshot => snapshot.val() || {
        conduct: {
            usafi: 'C',
            uaminifu: 'C',
            michezo: 'C',
            nidhamu: 'C',
            kazi: 'C',
            utunzaji_mali: 'C',
            uongozi: 'C'
        },
        classTeacherComment: '',
        headTeacherComment: ''
    });

    return reportData.then(data => {
        const validPoints = pointsArray.filter(p => p !== null);
        const edkIndex = getSubjects().indexOf('EDK');
        const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
        const otherPoints = validPoints
            .filter((p, idx) => idx !== edkIndex || edkPoint === null)
            .sort((a, b) => a - b);
        const topPoints = edkPoint !== null 
            ? [edkPoint, ...otherPoints.slice(0, 6)]
            : otherPoints.slice(0, 7);
        const totalPoints = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';

        // Student Details
        const studentDetails = [
            { Field: 'Name', Value: student.fullName },
            { Field: 'Term', Value: term },
            { Field: 'Division', Value: getDivision(pointsArray) },
            { Field: 'Points', Value: totalPoints },
            { Field: 'Grade', Value: getOverallGrade(studentResults) },
            { Field: 'Class', Value: `${student.class} ${student.stream}` }
        ];

        // Academic Performance
        const academicData = getSubjects().map(subject => {
            const result = studentResults.find(r => r.subject === subject);
            const grade = result ? getGrade(result.marks) : '-';
            return {
                Subject: subject,
                Grade: grade,
                Remarks: getSubjectRemarks(grade)
            };
        });

        // Behavior and Conduct
        const conductData = [
            { Criteria: 'Usafi', Grade: data.conduct.usafi || 'C' },
            { Criteria: 'Uaminifu', Grade: data.conduct.uaminifu || 'C' },
            { Criteria: 'Michezo', Grade: data.conduct.michezo || 'C' },
            { Criteria: 'Nidhamu', Grade: data.conduct.nidhamu || 'C' },
            { Criteria: 'Kazi', Grade: data.conduct.kazi || 'C' },
            { Criteria: 'Utunzaji Mali', Grade: data.conduct.utunzaji_mali || 'C' },
            { Criteria: 'Uongozi', Grade: data.conduct.uongozi || 'C' }
        ];

        // Comments
        const commentsData = [
            { Field: 'Class Teacher Comment', Value: data.classTeacherComment || '' },
            { Field: 'Head Teacher Comment', Value: data.headTeacherComment || '' },
            { Field: 'School Closed', Value: closeDate },
            { Field: 'School Reopens', Value: reopenDate }
        ];

        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(studentDetails), 'Student Details');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(academicData), 'Academic Performance');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(conductData), 'Conduct');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(commentsData), 'Comments');

        // Save file
        XLSX.writeFile(wb, `Bismarck_Report_${student.fullName}_${examType}_${year}.xlsx`);
    }).catch(error => {
        showNotification('Error', `Failed to export report: ${error.message}`, 'error');
    });
}

// Export All Student Reports to Excel
function exportReportsToExcel() {
    console.log('Exporting all student reports to Excel');
    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    database.ref(`reports/${studentClass}_${stream}_${year}_${examType}`).once('value', snapshot => {
        const savedReports = snapshot.val() || {};
        const filteredStudents = students
            .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
            .sort((a, b) => a.fullName.localeCompare(b.fullName));

        if (!filteredStudents.length) {
            showNotification('Information', 'No students found!', 'error');
            return;
        }

        const wb = XLSX.utils.book_new();
        filteredStudents.forEach(student => {
            const studentResults = results.filter(r => r.studentId === student.id && r.examType === examType && r.year === year);
            const reportData = savedReports[student.id] || {
                conduct: {
                    usafi: 'C',
                    uaminifu: 'C',
                    michezo: 'C',
                    nidhamu: 'C',
                    kazi: 'C',
                    utunzaji_mali: 'C',
                    uongozi: 'C'
                },
                classTeacherComment: '',
                headTeacherComment: ''
            };

            const pointsArray = getSubjects().map(subject => {
                const result = studentResults.find(r => r.subject === subject);
                return result && ['A', 'B', 'C', 'D', 'F'].includes(getGrade(result.marks)) ? getPoints(getGrade(result.marks)) : null;
            });

            const term = getTermFromExamType(examType);
            const month = new Date().toLocaleString('default', { month: 'long' });
            const closeDate = document.getElementById('schoolCloseDate').value || '';
            const reopenDate = document.getElementById('schoolReopenDate').value || '';

            const validPoints = pointsArray.filter(p => p !== null);
            const edkIndex = getSubjects().indexOf('EDK');
            const edkPoint = edkIndex !== -1 && pointsArray[edkIndex] !== null ? pointsArray[edkIndex] : null;
            const otherPoints = validPoints
                .filter((p, idx) => idx !== edkIndex || edkPoint === null)
                .sort((a, b) => a - b);
            const topPoints = edkPoint !== null 
                ? [edkPoint, ...otherPoints.slice(0, 6)]
                : otherPoints.slice(0, 7);
            const totalPoints = topPoints.length >= 7 ? topPoints.reduce((sum, p) => sum + p, 0) : '-';

            // Student Report Data
            const reportDataArray = [
                { Section: 'Student Details', Field: 'Name', Value: student.fullName },
                { Section: 'Student Details', Field: 'Term', Value: term },
                { Section: 'Student Details', Field: 'Division', Value: getDivision(pointsArray) },
                { Section: 'Student Details', Field: 'Points', Value: totalPoints },
                { Section: 'Student Details', Field: 'Grade', Value: getOverallGrade(studentResults) },
                { Section: 'Student Details', Field: 'Class', Value: `${student.class} ${student.stream}` },
                ...getSubjects().map(subject => {
                    const result = studentResults.find(r => r.subject === subject);
                    const grade = result ? getGrade(result.marks) : '-';
                    return {
                        Section: 'Academic Performance',
                        Field: subject,
                        Value: grade,
                        Remarks: getSubjectRemarks(grade)
                    };
                }),
                ...Object.entries(reportData.conduct).map(([criteria, grade]) => ({
                    Section: 'Conduct',
                    Field: criteria.replace('_', ' ').toUpperCase(),
                    Value: grade || 'C'
                })),
                { Section: 'Comments', Field: 'Class Teacher Comment', Value: reportData.classTeacherComment || '' },
                { Section: 'Comments', Field: 'Head Teacher Comment', Value: reportData.headTeacherComment || '' },
                { Section: 'Comments', Field: 'School Closed', Value: closeDate },
                { Section: 'Comments', Field: 'School Reopens', Value: reopenDate }
            ];

            // Create worksheet for each student
            const ws = XLSX.utils.json_to_sheet(reportDataArray);
            XLSX.utils.book_append_sheet(wb, ws, student.fullName.slice(0, 31)); // Sheet names limited to 31 chars
        });

        // Save file
        XLSX.writeFile(wb, `Bismarck_Student_Reports_${studentClass}_${stream}_${examType}_${year}.xlsx`);
    }).catch(error => {
        showNotification('Error', `Failed to export reports: ${error.message}`, 'error');
    });
}

function loginAcademic() {
    console.log('Attempting academic login');
    const password = document.getElementById('academicPassword').value;

    if (password === ACADEMIC_PASSWORD) {
        currentAcademic = true;
        document.getElementById('academicLoginForm').style.display = 'none';
        document.getElementById('academicPanel').style.display = 'block';
        showNotification('Success', 'Logged in as Academic Officer!', 'success');
        loadTeacherList();
        loadStudentDeleteList();
    } else {
        showNotification('Error', 'Incorrect password!', 'error');
    }
}
function autoPrintReports() {
    console.log('Auto printing individual student reports');
    const studentClass = document.getElementById('reportClass').value;
    const stream = document.getElementById('reportStream').value;
    const year = document.getElementById('reportYear').value;
    const examType = document.getElementById('reportExamType').value;
    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!filteredStudents.length) {
        showNotification('Information', 'No students found!', 'error');
        return;
    }

    let printedStudents = JSON.parse(localStorage.getItem(`printedReports_${studentClass}_${stream}_${year}_${examType}`)) || [];

    filteredStudents.forEach((student, index) => {
        if (!printedStudents.includes(student.id)) {
            const reportContainer = document.querySelector(`.report-container[data-student-id="${student.id}"]`);
            if (reportContainer) {
                setTimeout(() => {
                    const opt = {
                        margin: 0.5,
                        filename: `Bismarck_Report_${student.fullName}_${examType}_${year}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };
                    html2pdf().from(reportContainer).set(opt).save().then(() => {
                        printedStudents.push(student.id);
                        localStorage.setItem(`printedReports_${studentClass}_${stream}_${year}_${examType}`, JSON.stringify(printedStudents));
                        showNotification('Success', `Printed report for ${student.fullName}`, 'success');
                    });
                }, index * 1000); // Delay to prevent browser overload
            }
        }
    });

    if (printedStudents.length === filteredStudents.length) {
        showNotification('Information', 'All reports have been printed!', 'info');
        localStorage.removeItem(`printedReports_${studentClass}_${stream}_${year}_${examType}`);
    }
}

function logoutAcademic() {
    console.log('Logging out academic');
    currentAcademic = null;
    document.getElementById('academicLoginForm').style.display = 'block';
    document.getElementById('academicPanel').style.display = 'none';
    showNotification('Success', 'Logged out successfully!', 'success');
    openTab('home');
}

function saveExamTypeSettings(event) {
    event.preventDefault();
    console.log('Saving exam type settings');
    const allowedExamTypesSelect = document.getElementById('allowedExamTypes');
    const selectedOptions = Array.from(allowedExamTypesSelect.selectedOptions).map(option => option.value);

    if (!selectedOptions.length) {
        showNotification('Information', 'Please select at least one exam type!', 'error');
        return;
    }

    allowedExamTypes = selectedOptions;
    database.ref('settings/examTypes').set(allowedExamTypes)
        .then(() => {
            showNotification('Success', 'Exam types updated successfully!', 'success');
            updateExamTypeDropdowns();
        })
        .catch(error => {
            showNotification('Error', `Failed to update exam types: ${error.message}`, 'error');
        });
}

function updateExamTypeDropdowns() {
    const examTypeSelects = [
        'searchExamType', 'resultExamType', 'resultsExamType',
        'pastResultsExamType', 'smsExamType', 'editResultExamType',
        'deleteExamType', 'archiveExamType', 'reportExamType'
    ];
    examTypeSelects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = '<option value="">Select Exam Type</option>';
            allowedExamTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }
    });
}

function postAnnouncement(event) {
    event.preventDefault();
    console.log('Posting announcement');
    const announcementInput = document.getElementById('announcementTextInput');
    const announcementText = announcementInput ? announcementInput.value.trim() : '';

    if (!announcementText) {
        showNotification('Information', 'Please enter an announcement!', 'error');
        return;
    }

    currentAnnouncement = {
        text: announcementText,
        timestamp: new Date().toISOString()
    };

    database.ref('announcement').set(currentAnnouncement)
        .then(() => {
            showNotification('Success', 'Announcement posted successfully!', 'success');
            loadAnnouncements();
            announcementInput.value = '';
        })
        .catch(error => {
            showNotification('Error', `Failed to post announcement: ${error.message}`, 'error');
        });
}

function deleteAnnouncement() {
    console.log('Deleting announcement');
    currentAnnouncement = null;
    database.ref('announcement').remove()
        .then(() => {
            showNotification('Success', 'Announcement deleted successfully!', 'success');
            loadAnnouncements();
        })
        .catch(error => {
            showNotification('Error', `Failed to delete announcement: ${error.message}`, 'error');
        });
}

function loadAnnouncements() {
    console.log('Loading announcements');
    const announcementText = document.getElementById('announcementText');
    const announcementTimestamp = document.getElementById('announcementTimestamp');

    if (currentAnnouncement) {
        announcementText.textContent = currentAnnouncement.text;
        const date = new Date(currentAnnouncement.timestamp);
        announcementTimestamp.textContent = `Posted on ${date.getDate()} ${getMonthName(date)} ${date.getFullYear()} at ${date.toLocaleTimeString()}`;
    } else {
        announcementText.textContent = 'No announcements at the moment.';
        announcementTimestamp.textContent = '';
    }
}

function loadTeacherList() {
    console.log('Loading teacher list');
    const teacherListDiv = document.getElementById('teacherList');
    if (!teacherListDiv) return;

    let html = '<h3>Registered Teachers</h3><div class="table-container"><table class="table"><thead><tr><th>Select</th><th>Name</th><th>Subject</th></tr></thead><tbody>';
    teachers.forEach(teacher => {
        html += `<tr><td><input type="checkbox" class="teacher-checkbox" data-teacher-id="${teacher.id}"></td><td>${teacher.name}</td><td>${teacher.subject}</td></tr>`;
    });
    html += '</tbody></table></div>';
    teacherListDiv.innerHTML = html;
}

function deleteTeacher() {
    console.log('Deleting selected teacher');
    const checkboxes = document.querySelectorAll('.teacher-checkbox:checked');
    if (!checkboxes.length) {
        showNotification('Information', 'No teachers selected!', 'error');
        return;
    }

    const updates = {};
    checkboxes.forEach(checkbox => {
        const teacherId = checkbox.getAttribute('data-teacher-id');
        updates[teacherId] = null;
    });

    database.ref('teachers').update(updates)
        .then(() => {
            teachers = teachers.filter(t => !Array.from(checkboxes).some(cb => cb.getAttribute('data-teacher-id') === t.id));
            showNotification('Success', 'Teacher(s) deleted successfully!', 'success');
            loadTeacherList();
        })
        .catch(error => {
            showNotification('Error', `Failed to delete teacher(s): ${error.message}`, 'error');
        });
}

function loadStudentDeleteList() {
    console.log('Loading student delete list');
    const studentClass = document.getElementById('deleteStudentClass').value;
    const stream = document.getElementById('deleteStudentStream').value;
    const year = document.getElementById('deleteStudentYear').value;
    const studentDeleteListDiv = document.getElementById('studentDeleteList');

    if (!studentClass || !stream || !year || !studentDeleteListDiv) {
        studentDeleteListDiv.innerHTML = '<p>Please select class, stream, and year!</p>';
        return;
    }

    const filteredStudents = students
        .filter(s => s.class === studentClass && s.stream === stream && s.year === year)
        .sort((a, b) => a.fullName.localeCompare(b.fullName));

    if (!filteredStudents.length) {
        studentDeleteListDiv.innerHTML = '<p>No students found!</p>';
        return;
    }

    let html = '<h3>Students</h3><div class="table-container"><table class="table"><thead><tr><th>Select</th><th>Name</th><th>Class</th><th>Stream</th><th>Year</th></tr></thead><tbody>';
    filteredStudents.forEach(student => {
        html += `<tr><td><input type="checkbox" class="student-checkbox" data-student-id="${student.id}"></td><td>${student.fullName}</td><td>${student.class}</td><td>${student.stream}</td><td>${student.year}</td></tr>`;
    });
    html += '</tbody></table></div>';
    studentDeleteListDiv.innerHTML = html;
}

function deleteStudent() {
    console.log('Deleting selected students');
    const checkboxes = document.querySelectorAll('.student-checkbox:checked');
    if (!checkboxes.length) {
        showNotification('Information', 'No students selected!', 'error');
        return;
    }

    const updates = {};
    checkboxes.forEach(checkbox => {
        const studentId = checkbox.getAttribute('data-student-id');
        updates[studentId] = null;
    });

    database.ref('students').update(updates)
        .then(() => {
            students = students.filter(s => !Array.from(checkboxes).some(cb => cb.getAttribute('data-student-id') === s.id));
            showNotification('Success', 'Student(s) deleted successfully!', 'success');
            loadStudentDeleteList();
        })
        .catch(error => {
            showNotification('Error', `Failed to delete student(s): ${error.message}`, 'error');
        });
}

function saveFeatureVisibility(event) {
    event.preventDefault();
    console.log('Saving feature visibility');
    visibleFeatures = {
        register: document.getElementById('visibleRegister').checked,
        students: document.getElementById('visibleStudents').checked,
        resultsEntry: document.getElementById('visibleResultsEntry').checked,
        results: document.getElementById('visibleResults').checked,
        pastResults: document.getElementById('visiblePastResults').checked,
        sms: document.getElementById('visibleSMS').checked,
        studentReports: document.getElementById('visibleStudentReports').checked
    };

    database.ref('settings/visibleFeatures').set(visibleFeatures)
        .then(() => {
            showNotification('Success', 'Feature visibility updated successfully!', 'success');
            document.querySelectorAll('.tab-item').forEach(item => {
                const tabName = item.getAttribute('data-tab');
                if (!visibleFeatures[tabName] && tabName !== 'home' && tabName !== 'academic') {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'block';
                }
            });
        })
        .catch(error => {
            showNotification('Error', `Failed to update feature visibility: ${error.message}`, 'error');
        });
}

function changeAcademicPassword(event) {
    event.preventDefault();
    console.log('Changing academic password');
    const newPassword = document.getElementById('newAcademicPassword').value;
    const confirmPassword = document.getElementById('confirmAcademicPassword').value;

    if (newPassword !== confirmPassword) {
        showNotification('Information', 'Passwords do not match!', 'error');
        return;
    }

    if (!newPassword) {
        showNotification('Information', 'Please enter a password!', 'error');
        return;
    }

    ACADEMIC_PASSWORD = newPassword;
    database.ref('settings/academicPassword').set(newPassword)
        .then(() => {
            showNotification('Success', 'Password changed successfully!', 'success');
            document.getElementById('changePasswordForm').reset();
        })
        .catch(error => {
            showNotification('Error', `Failed to change password: ${error.message}`, 'error');
        });
}
function saveGlobalReportSettings(event) {
    event.preventDefault();
    console.log('Saving global report settings');
    const classTeacherComment = document.getElementById('globalClassTeacherComment').value.trim();
    const headTeacherComment = document.getElementById('globalHeadTeacherComment').value.trim();
    const conduct = {};
    ['usafi', 'uaminifu', 'michezo', 'nidhamu', 'kazi', 'utunzaji_mali', 'uongozi'].forEach(criteria => {
        const value = document.getElementById(`globalConduct_${criteria}`).value;
        if (value) conduct[criteria] = value;
    });

    const settings = {
        classTeacherComment,
        headTeacherComment,
        conduct,
        timestamp: new Date().toISOString()
    };

    database.ref('settings/globalReportSettings').set(settings)
        .then(() => {
            showNotification('Success', 'Global report settings saved successfully!', 'success');
            document.getElementById('globalReportSettingsForm').reset();
        })
        .catch(error => {
            showNotification('Error', `Failed to save global settings: ${error.message}`, 'error');
        });
}

function deleteResults() {
    console.log('Deleting results');
    const studentClass = document.getElementById('deleteClass').value;
    const stream = document.getElementById('deleteStream').value;
    const year = document.getElementById('deleteYear').value;
    const examType = document.getElementById('deleteExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    const resultsToDelete = results.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType
    );

    if (!resultsToDelete.length) {
        showNotification('Information', 'No results found to delete!', 'error');
        return;
    }

    const updates = {};
    resultsToDelete.forEach(result => {
        updates[result.id] = null;
    });

    database.ref('results').update(updates)
        .then(() => {
            results = results.filter(r => !resultsToDelete.includes(r));
            showNotification('Success', 'Results deleted successfully!', 'success');
        })
        .catch(error => {
            showNotification('Error', `Failed to delete results: ${error.message}`, 'error');
        });
}

function archiveResults() {
    console.log('Archiving results');
    const studentClass = document.getElementById('archiveClass').value;
    const stream = document.getElementById('archiveStream').value;
    const year = document.getElementById('archiveYear').value;
    const examType = document.getElementById('archiveExamType').value;

    if (!studentClass || !stream || !year || !examType) {
        showNotification('Information', 'Please select class, stream, year, and exam type!', 'error');
        return;
    }

    const resultsToArchive = results.filter(r =>
        r.class === studentClass &&
        r.stream === stream &&
        r.year === year &&
        r.examType === examType
    );

    if (!resultsToArchive.length) {
        showNotification('Information', 'No results found to archive!', 'error');
        return;
    }

    const archiveUpdates = {};
    const deleteUpdates = {};
    resultsToArchive.forEach(result => {
        const pastResultRef = database.ref('pastResults').push();
        archiveUpdates[pastResultRef.key] = { ...result, archived: true };
        pastResults.push({ id: pastResultRef.key, ...result, archived: true });
        deleteUpdates[result.id] = null;
    });

    // Archive to pastResults
    database.ref('pastResults').update(archiveUpdates)
        .then(() => {
            // Delete from results
            return database.ref('results').update(deleteUpdates);
        })
        .then(() => {
            results = results.filter(r => !resultsToArchive.includes(r));
            showNotification('Success', 'Results archived and removed from current results successfully!', 'success');
        })
        .catch(error => {
            showNotification('Error', `Failed to archive results: ${error.message}`, 'error');
        });
}

function registerTeacher(event) {
    event.preventDefault();
    console.log('Registering teacher');
    const teacherName = document.getElementById('authTeacherName').value.trim();
    const password = document.getElementById('authTeacherPassword').value;
    const subject = document.getElementById('authSubject').value;

    if (!teacherName || !password || !subject) {
        showNotification('Information', 'Please fill all fields!', 'error');
        return;
    }

    if (teachers.some(t => t.name === teacherName && t.subject === subject)) {
        showNotification('Information', 'Teacher already registered for this subject!', 'error');
        return;
    }

    const teacherRef = database.ref('teachers').push();
    const teacherData = { name: teacherName, password, subject };
    database.ref(`teachers/${teacherRef.key}`).set(teacherData)
        .then(() => {
            teachers.push({ id: teacherRef.key, ...teacherData });
            showNotification('Success', 'Teacher registered successfully!', 'success');
            document.getElementById('teacherAuthForm').reset();
            if (currentAcademic) loadTeacherList();
        })
        .catch(error => {
            showNotification('Error', `Failed to register teacher: ${error.message}`, 'error');
        });
}

function loginTeacher(event) {
    event.preventDefault();
    console.log('Attempting teacher login');
    const teacherName = document.getElementById('authTeacherName').value.trim();
    const password = document.getElementById('authTeacherPassword').value;
    const subject = document.getElementById('authSubject').value;

    const teacher = teachers.find(t => t.name === teacherName && t.password === password && t.subject === subject);

    if (teacher) {
        currentTeacher = { name: teacherName, subject };
        document.getElementById('teacherAuthPanel').style.display = 'none';
        document.getElementById('resultsEntryPanel').style.display = 'block';
        document.getElementById('editResultsPanel').style.display = 'block';
        showNotification('Success', 'Logged in successfully!', 'success');
        populateSubjectOptions();
    } else {
        showNotification('Error', 'Invalid credentials!', 'error');
    }
}

function logoutTeacher() {
    console.log('Logging out teacher');
    currentTeacher = null;
    document.getElementById('teacherAuthPanel').style.display = 'block';
    document.getElementById('resultsEntryPanel').style.display = 'none';
    document.getElementById('editResultsPanel').style.display = 'none';
    showNotification('Success', 'Logged out successfully!', 'success');
    openTab('home');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing system');
    const loadingSpinner = document.getElementById('loadingSpinner');
    setTimeout(() => {
        loadingSpinner.classList.add('hidden');
    }, 2000);

    // Load data from Firebase
    database.ref('students').once('value', snapshot => {
        students = [];
        snapshot.forEach(child => {
            students.push({ id: child.key, ...child.val() });
        });
    });

    database.ref('teachers').once('value', snapshot => {
        teachers = [];
        snapshot.forEach(child => {
            teachers.push({ id: child.key, ...child.val() });
        });
    });

    database.ref('results').once('value', snapshot => {
        results = [];
        snapshot.forEach(child => {
            results.push({ id: child.key, ...child.val() });
        });
    });

    database.ref('pastResults').once('value', snapshot => {
        pastResults = [];
        snapshot.forEach(child => {
            pastResults.push({ id: child.key, ...child.val() });
        });
    });

    database.ref('announcement').once('value', snapshot => {
        currentAnnouncement = snapshot.val();
        loadAnnouncements();
    });

    database.ref('settings/examTypes').once('value', snapshot => {
        if (snapshot.val()) allowedExamTypes = snapshot.val();
        updateExamTypeDropdowns();
    });

    database.ref('settings/visibleFeatures').once('value', snapshot => {
        if (snapshot.val()) visibleFeatures = snapshot.val();
        document.querySelectorAll('.tab-item').forEach(item => {
            const tabName = item.getAttribute('data-tab');
            if (!visibleFeatures[tabName] && tabName !== 'home' && tabName !== 'academic') {
                item.style.display = 'none';
            }
        });
    });

    database.ref('settings/academicPassword').once('value', snapshot => {
        if (snapshot.val()) ACADEMIC_PASSWORD = snapshot.val();
    });

    database.ref('sms').once('value', snapshot => {
        sentSMSes = [];
        snapshot.forEach(child => {
            sentSMSes.push(child.val());
        });
    });

    // Event Listeners
    document.querySelectorAll('.tab-item').forEach(item => {
        item.addEventListener('click', () => openTab(item.getAttribute('data-tab')));
    });
    
    
document.getElementById('globalReportSettingsForm').addEventListener('submit', saveGlobalReportSettings);
   document.getElementById('autoPrintReportsBtn').addEventListener('click', autoPrintReports);
    document.getElementById('registrationForm').addEventListener('submit', registerStudents);
    document.getElementById('searchStudentBtn').addEventListener('click', searchStudent);
    document.getElementById('viewStudentsBtn').addEventListener('click', viewStudents);
    document.getElementById('showStudentListBtn').addEventListener('click', () => showSection('studentList', 'showStudentListBtn', 'hideStudentListBtn'));
    document.getElementById('hideStudentListBtn').addEventListener('click', () => hideSection('studentList', 'showStudentListBtn', 'hideStudentListBtn'));
    document.getElementById('loadStudentsForResultsBtn').addEventListener('click', loadStudentsForResults);
    document.getElementById('showResultEntryFormBtn').addEventListener('click', () => showSection('resultEntryForm', 'showResultEntryFormBtn', 'hideResultEntryFormBtn'));
    document.getElementById('hideResultEntryFormBtn').addEventListener('click', () => hideSection('resultEntryForm', 'showResultEntryFormBtn', 'hideResultEntryFormBtn'));
    document.getElementById('saveMarksBtn').addEventListener('click', saveMarks);
    document.getElementById('showResultsTableBtn').addEventListener('click', () => showSection('resultsTable', 'showResultsTableBtn', 'hideResultsTableBtn'));
    document.getElementById('hideResultsTableBtn').addEventListener('click', () => hideSection('resultsTable', 'showResultsTableBtn', 'hideResultsTableBtn'));
    document.getElementById('submitResultsBtn').addEventListener('click', submitResults);
    document.getElementById('loadEditResultsBtn').addEventListener('click', loadEditResults);
    document.getElementById('showEditResultsTableBtn').addEventListener('click', () => showSection('editResultsTable', 'showEditResultsTableBtn', 'hideEditResultsTableBtn'));
    document.getElementById('hideEditResultsTableBtn').addEventListener('click', () => hideSection('editResultsTable', 'showEditResultsTableBtn', 'hideEditResultsTableBtn'));
    document.getElementById('updateResultsBtn').addEventListener('click', loadEditResults);
    document.getElementById('viewResultsBtn').addEventListener('click', viewResults);
    document.getElementById('printResultsBtn').addEventListener('click', printResults);
    document.getElementById('exportToCSVBtn').addEventListener('click', exportToCSV);
    document.getElementById('exportToWordBtn').addEventListener('click', exportToWord);
    document.getElementById('showResultsDisplayBtn').addEventListener('click', () => showSection('resultsDisplay', 'showResultsDisplayBtn', 'hideResultsDisplayBtn'));
    document.getElementById('hideResultsDisplayBtn').addEventListener('click', () => hideSection('resultsDisplay', 'showResultsDisplayBtn', 'hideResultsDisplayBtn'));
    document.getElementById('viewPastResultsBtn').addEventListener('click', viewPastResults);
    document.getElementById('showPastResultsDisplayBtn').addEventListener('click', () => showSection('pastResultsDisplay', 'showPastResultsDisplayBtn', 'hidePastResultsDisplayBtn'));
    document.getElementById('hidePastResultsDisplayBtn').addEventListener('click', () => hideSection('pastResultsDisplay', 'showPastResultsDisplayBtn', 'hidePastResultsDisplayBtn'));
    document.getElementById('printPastResultsBtn').addEventListener('click', printPastResults);
    document.getElementById('exportPastToWordBtn').addEventListener('click', exportPastToWord);
    document.getElementById('loadStudentsForSMSBtn').addEventListener('click', loadStudentsForSMS);
    document.getElementById('generateReportsBtn').addEventListener('click', generateStudentReports);
    document.getElementById('printReportsBtn').addEventListener('click', printReports);
    document.getElementById('exportReportsToWordBtn').addEventListener('click', exportReportsToWord);
    document.getElementById('loginAcademicBtn').addEventListener('click', loginAcademic);
    document.getElementById('logoutAcademicBtn').addEventListener('click', logoutAcademic);
    document.getElementById('examTypeSettingsForm').addEventListener('submit', saveExamTypeSettings);
    document.getElementById('announcementForm').addEventListener('submit', postAnnouncement);
    document.getElementById('deleteAnnouncementBtn').addEventListener('click', deleteAnnouncement);
    document.getElementById('deleteTeacherBtn').addEventListener('click', deleteTeacher);
    document.getElementById('deleteStudentBtn').addEventListener('click', deleteStudent);
    document.getElementById('featureVisibilityForm').addEventListener('submit', saveFeatureVisibility);
    document.getElementById('changePasswordForm').addEventListener('submit', changeAcademicPassword);
    document.getElementById('deleteResultsBtn').addEventListener('click', deleteResults);
    document.getElementById('archiveResultsBtn').addEventListener('click', archiveResults);
    document.getElementById('registerTeacherBtn').addEventListener('click', registerTeacher);
    document.getElementById('loginTeacherBtn').addEventListener('click', loginTeacher);
    document.getElementById('logoutTeacherBtn').addEventListener('click', logoutTeacher);

    document.getElementById('poweredByBtn').addEventListener('click', () => {
        showNotification('Information', 'This system is powered by Malosha more information call DAVID MALOSHA 0785197452!', 'info');
    });

    // Update student delete list on change
        ['deleteStudentClass', 'deleteStudentStream', 'deleteStudentYear'].forEach(id => {
        document.getElementById(id).addEventListener('change', loadStudentDeleteList);
    });
});
</script>
</body>
</html>
